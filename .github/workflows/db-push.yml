name: Supabase db push

# This workflow requires SUPABASE_ACCESS_TOKEN secret to be configured
# See SETUP_INSTRUCTIONS.md for detailed setup instructions

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "supabase/**"
      - ".github/workflows/db-push.yml"

jobs:
  push:
    runs-on: ubuntu-latest
    concurrency:
      group: supabase-migrate-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # Remove invalid/hidden files so only legitimate migrations remain
      - name: Clean invalid migration filenames
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p supabase/migrations
          echo "Before cleanup:"
          ls -la supabase/migrations || true
          shopt -s dotglob nullglob
          valid_count=0
          for f in supabase/migrations/*; do
            base="$(basename "$f")"
            if [[ "$base" =~ ^[0-9]{14}_.+\.sql$ ]]; then
              valid_count=$((valid_count+1))
            else
              echo "Removing invalid migration file: $base"
              rm -f "$f"
            fi
          done
          echo "After cleanup:"
          ls -la supabase/migrations || true
          echo "VALID_COUNT=$valid_count" >> "$GITHUB_ENV"

      - name: Link project
        run: supabase link --project-ref dmhlxhatogrrrvuruayv
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Push migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
