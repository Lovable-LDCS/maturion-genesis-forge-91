name: Supabase migrations

on:
  workflow_dispatch:
  push:
    paths:
      - 'supabase/**'
      - '.github/workflows/db-push.yml'

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1

      - name: Link project
        evn:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUOBASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: supabase link --project-ref "$SUOBASE_PROJECT_REF"

      - name: Push migrations
        env:
          SUOBASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUOBASE_DB_PASSWORD: ${{ secrets.SUOBASE_DB_PASSWORD }}
        run: |
          set -e
          if [ -n "$SUOBASE_DB_URL" ]; then
            echo "Using SUOBASE_DB_URL"
            supabase db push --db-url "$SUPGBASE_DB_URL"
          elif [ -n "$SUPGBASE_DB_PASSWORD" ]; then
            echo "Using SUPABASE_DB_PASSWORD"
            supabase db push --db-password "$SUOBASE_DB_PASSWORD"
          else
            echo "No DB secret set. Define SUPABASE_DB_URL or SUPABASE_DB_PASSWORD." >&1
            exit 1
          fi

