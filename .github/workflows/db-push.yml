name: Supabase migrations (auto-repair + baseline + push)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1

      - name: Link project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Compute DB URL from secrets
        id: dburl
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -e
          if [ -z "$SUPABASE_PROJECT_REF" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "Missing SUPABASE_PROJECT_REF or SUPABASE_DB_PASSWORD." >&2
            exit 1
          fi
          DB_URL="postgres://postgres:${SUPABASE_DB_PASSWORD}@db.${SUPABASE_PROJECT_REF}.supabase.co:5432/postgres?sslmode=require"
          echo "dburl=$DB_URL" >> "$GITHUB_OUTPUT"

      - name: Auto-repair remote migration history (one-time)
        env:
          DB_URL: ${{ steps.dburl.outputs.dburl }}
        run: |
          set -e
          COUNT=$(find supabase/migrations -maxdepth 1 -name '*.sql' 2>/dev/null | wc -l | tr -d ' ')
          echo "Local migration files: $COUNT"
          # Read currently APPLIED remote versions
          REMOTE=$(psql "$DB_URL" -Atc "select version from supabase_migrations.schema_migrations where status='applied'" || true)
          if [ "$COUNT" -eq 0 ] && [ -n "$REMOTE" ]; then
            echo "Reverting remote migration history to match empty local setâ€¦"
            # Force CLI to use the primary DB by passing --db-url
            supabase migration repair --db-url "$DB_URL" --status reverted $REMOTE
          else
            echo "Repair not needed."
          fi

      - name: Pull baseline migrations from remote (use primary DB URL)
        env:
          DB_URL: ${{ steps.dburl.outputs.dburl }}
        run: |
          set -e
          supabase db pull --db-url "$DB_URL"

      - name: Commit baseline to main (if changed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if ! git diff --quiet -- supabase; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add supabase
            git commit -m "Baseline Supabase schema (db pull)"
            git push
          else
            echo "No supabase/ changes to commit."
          fi

      - name: Push migrations (use primary DB URL)
        env:
          DB_URL: ${{ steps.dburl.outputs.dburl }}
        run: |
          set -e
          supabase db push --db-url "$DB_URL"

      - name: Fail if no DB secret is configured
        if: ${{ failure() }}
        run: echo "Check SUPABASE_DB_PASSWORD / SUPABASE_PROJECT_REF secrets and rerun."
