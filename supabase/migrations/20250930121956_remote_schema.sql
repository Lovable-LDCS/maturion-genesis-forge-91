create extension if not exists "pg_net" with schema "public" version '0.19.5';

revoke delete on table "public"."adaptive_learning_metrics" from "anon";

revoke insert on table "public"."adaptive_learning_metrics" from "anon";

revoke references on table "public"."adaptive_learning_metrics" from "anon";

revoke select on table "public"."adaptive_learning_metrics" from "anon";

revoke trigger on table "public"."adaptive_learning_metrics" from "anon";

revoke truncate on table "public"."adaptive_learning_metrics" from "anon";

revoke update on table "public"."adaptive_learning_metrics" from "anon";

revoke delete on table "public"."adaptive_learning_metrics" from "authenticated";

revoke insert on table "public"."adaptive_learning_metrics" from "authenticated";

revoke references on table "public"."adaptive_learning_metrics" from "authenticated";

revoke select on table "public"."adaptive_learning_metrics" from "authenticated";

revoke trigger on table "public"."adaptive_learning_metrics" from "authenticated";

revoke truncate on table "public"."adaptive_learning_metrics" from "authenticated";

revoke update on table "public"."adaptive_learning_metrics" from "authenticated";

revoke delete on table "public"."adaptive_learning_metrics" from "service_role";

revoke insert on table "public"."adaptive_learning_metrics" from "service_role";

revoke references on table "public"."adaptive_learning_metrics" from "service_role";

revoke select on table "public"."adaptive_learning_metrics" from "service_role";

revoke trigger on table "public"."adaptive_learning_metrics" from "service_role";

revoke truncate on table "public"."adaptive_learning_metrics" from "service_role";

revoke update on table "public"."adaptive_learning_metrics" from "service_role";

revoke delete on table "public"."admin_activity_log" from "anon";

revoke insert on table "public"."admin_activity_log" from "anon";

revoke references on table "public"."admin_activity_log" from "anon";

revoke select on table "public"."admin_activity_log" from "anon";

revoke trigger on table "public"."admin_activity_log" from "anon";

revoke truncate on table "public"."admin_activity_log" from "anon";

revoke update on table "public"."admin_activity_log" from "anon";

revoke delete on table "public"."admin_activity_log" from "authenticated";

revoke insert on table "public"."admin_activity_log" from "authenticated";

revoke references on table "public"."admin_activity_log" from "authenticated";

revoke select on table "public"."admin_activity_log" from "authenticated";

revoke trigger on table "public"."admin_activity_log" from "authenticated";

revoke truncate on table "public"."admin_activity_log" from "authenticated";

revoke update on table "public"."admin_activity_log" from "authenticated";

revoke delete on table "public"."admin_activity_log" from "service_role";

revoke insert on table "public"."admin_activity_log" from "service_role";

revoke references on table "public"."admin_activity_log" from "service_role";

revoke select on table "public"."admin_activity_log" from "service_role";

revoke trigger on table "public"."admin_activity_log" from "service_role";

revoke truncate on table "public"."admin_activity_log" from "service_role";

revoke update on table "public"."admin_activity_log" from "service_role";

revoke delete on table "public"."admin_approval_requests" from "anon";

revoke insert on table "public"."admin_approval_requests" from "anon";

revoke references on table "public"."admin_approval_requests" from "anon";

revoke select on table "public"."admin_approval_requests" from "anon";

revoke trigger on table "public"."admin_approval_requests" from "anon";

revoke truncate on table "public"."admin_approval_requests" from "anon";

revoke update on table "public"."admin_approval_requests" from "anon";

revoke delete on table "public"."admin_approval_requests" from "authenticated";

revoke insert on table "public"."admin_approval_requests" from "authenticated";

revoke references on table "public"."admin_approval_requests" from "authenticated";

revoke select on table "public"."admin_approval_requests" from "authenticated";

revoke trigger on table "public"."admin_approval_requests" from "authenticated";

revoke truncate on table "public"."admin_approval_requests" from "authenticated";

revoke update on table "public"."admin_approval_requests" from "authenticated";

revoke delete on table "public"."admin_approval_requests" from "service_role";

revoke insert on table "public"."admin_approval_requests" from "service_role";

revoke references on table "public"."admin_approval_requests" from "service_role";

revoke select on table "public"."admin_approval_requests" from "service_role";

revoke trigger on table "public"."admin_approval_requests" from "service_role";

revoke truncate on table "public"."admin_approval_requests" from "service_role";

revoke update on table "public"."admin_approval_requests" from "service_role";

revoke delete on table "public"."admin_users" from "anon";

revoke insert on table "public"."admin_users" from "anon";

revoke references on table "public"."admin_users" from "anon";

revoke select on table "public"."admin_users" from "anon";

revoke trigger on table "public"."admin_users" from "anon";

revoke truncate on table "public"."admin_users" from "anon";

revoke update on table "public"."admin_users" from "anon";

revoke delete on table "public"."admin_users" from "authenticated";

revoke insert on table "public"."admin_users" from "authenticated";

revoke references on table "public"."admin_users" from "authenticated";

revoke select on table "public"."admin_users" from "authenticated";

revoke trigger on table "public"."admin_users" from "authenticated";

revoke truncate on table "public"."admin_users" from "authenticated";

revoke update on table "public"."admin_users" from "authenticated";

revoke delete on table "public"."admin_users" from "service_role";

revoke insert on table "public"."admin_users" from "service_role";

revoke references on table "public"."admin_users" from "service_role";

revoke select on table "public"."admin_users" from "service_role";

revoke trigger on table "public"."admin_users" from "service_role";

revoke truncate on table "public"."admin_users" from "service_role";

revoke update on table "public"."admin_users" from "service_role";

revoke delete on table "public"."ai_behavior_monitoring" from "anon";

revoke insert on table "public"."ai_behavior_monitoring" from "anon";

revoke references on table "public"."ai_behavior_monitoring" from "anon";

revoke select on table "public"."ai_behavior_monitoring" from "anon";

revoke trigger on table "public"."ai_behavior_monitoring" from "anon";

revoke truncate on table "public"."ai_behavior_monitoring" from "anon";

revoke update on table "public"."ai_behavior_monitoring" from "anon";

revoke delete on table "public"."ai_behavior_monitoring" from "authenticated";

revoke insert on table "public"."ai_behavior_monitoring" from "authenticated";

revoke references on table "public"."ai_behavior_monitoring" from "authenticated";

revoke select on table "public"."ai_behavior_monitoring" from "authenticated";

revoke trigger on table "public"."ai_behavior_monitoring" from "authenticated";

revoke truncate on table "public"."ai_behavior_monitoring" from "authenticated";

revoke update on table "public"."ai_behavior_monitoring" from "authenticated";

revoke delete on table "public"."ai_behavior_monitoring" from "service_role";

revoke insert on table "public"."ai_behavior_monitoring" from "service_role";

revoke references on table "public"."ai_behavior_monitoring" from "service_role";

revoke select on table "public"."ai_behavior_monitoring" from "service_role";

revoke trigger on table "public"."ai_behavior_monitoring" from "service_role";

revoke truncate on table "public"."ai_behavior_monitoring" from "service_role";

revoke update on table "public"."ai_behavior_monitoring" from "service_role";

revoke delete on table "public"."ai_chunk_hash_stats" from "anon";

revoke insert on table "public"."ai_chunk_hash_stats" from "anon";

revoke references on table "public"."ai_chunk_hash_stats" from "anon";

revoke select on table "public"."ai_chunk_hash_stats" from "anon";

revoke trigger on table "public"."ai_chunk_hash_stats" from "anon";

revoke truncate on table "public"."ai_chunk_hash_stats" from "anon";

revoke update on table "public"."ai_chunk_hash_stats" from "anon";

revoke delete on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke insert on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke references on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke select on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke trigger on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke truncate on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke update on table "public"."ai_chunk_hash_stats" from "authenticated";

revoke delete on table "public"."ai_chunk_hash_stats" from "service_role";

revoke insert on table "public"."ai_chunk_hash_stats" from "service_role";

revoke references on table "public"."ai_chunk_hash_stats" from "service_role";

revoke select on table "public"."ai_chunk_hash_stats" from "service_role";

revoke trigger on table "public"."ai_chunk_hash_stats" from "service_role";

revoke truncate on table "public"."ai_chunk_hash_stats" from "service_role";

revoke update on table "public"."ai_chunk_hash_stats" from "service_role";

revoke delete on table "public"."ai_confidence_scoring" from "anon";

revoke insert on table "public"."ai_confidence_scoring" from "anon";

revoke references on table "public"."ai_confidence_scoring" from "anon";

revoke select on table "public"."ai_confidence_scoring" from "anon";

revoke trigger on table "public"."ai_confidence_scoring" from "anon";

revoke truncate on table "public"."ai_confidence_scoring" from "anon";

revoke update on table "public"."ai_confidence_scoring" from "anon";

revoke delete on table "public"."ai_confidence_scoring" from "authenticated";

revoke insert on table "public"."ai_confidence_scoring" from "authenticated";

revoke references on table "public"."ai_confidence_scoring" from "authenticated";

revoke select on table "public"."ai_confidence_scoring" from "authenticated";

revoke trigger on table "public"."ai_confidence_scoring" from "authenticated";

revoke truncate on table "public"."ai_confidence_scoring" from "authenticated";

revoke update on table "public"."ai_confidence_scoring" from "authenticated";

revoke delete on table "public"."ai_confidence_scoring" from "service_role";

revoke insert on table "public"."ai_confidence_scoring" from "service_role";

revoke references on table "public"."ai_confidence_scoring" from "service_role";

revoke select on table "public"."ai_confidence_scoring" from "service_role";

revoke trigger on table "public"."ai_confidence_scoring" from "service_role";

revoke truncate on table "public"."ai_confidence_scoring" from "service_role";

revoke update on table "public"."ai_confidence_scoring" from "service_role";

revoke delete on table "public"."ai_document_chunks" from "anon";

revoke insert on table "public"."ai_document_chunks" from "anon";

revoke references on table "public"."ai_document_chunks" from "anon";

revoke select on table "public"."ai_document_chunks" from "anon";

revoke trigger on table "public"."ai_document_chunks" from "anon";

revoke truncate on table "public"."ai_document_chunks" from "anon";

revoke update on table "public"."ai_document_chunks" from "anon";

revoke delete on table "public"."ai_document_chunks" from "authenticated";

revoke insert on table "public"."ai_document_chunks" from "authenticated";

revoke references on table "public"."ai_document_chunks" from "authenticated";

revoke select on table "public"."ai_document_chunks" from "authenticated";

revoke trigger on table "public"."ai_document_chunks" from "authenticated";

revoke truncate on table "public"."ai_document_chunks" from "authenticated";

revoke update on table "public"."ai_document_chunks" from "authenticated";

revoke delete on table "public"."ai_document_chunks" from "service_role";

revoke insert on table "public"."ai_document_chunks" from "service_role";

revoke references on table "public"."ai_document_chunks" from "service_role";

revoke select on table "public"."ai_document_chunks" from "service_role";

revoke trigger on table "public"."ai_document_chunks" from "service_role";

revoke truncate on table "public"."ai_document_chunks" from "service_role";

revoke update on table "public"."ai_document_chunks" from "service_role";

revoke delete on table "public"."ai_document_versions" from "anon";

revoke insert on table "public"."ai_document_versions" from "anon";

revoke references on table "public"."ai_document_versions" from "anon";

revoke select on table "public"."ai_document_versions" from "anon";

revoke trigger on table "public"."ai_document_versions" from "anon";

revoke truncate on table "public"."ai_document_versions" from "anon";

revoke update on table "public"."ai_document_versions" from "anon";

revoke delete on table "public"."ai_document_versions" from "authenticated";

revoke insert on table "public"."ai_document_versions" from "authenticated";

revoke references on table "public"."ai_document_versions" from "authenticated";

revoke select on table "public"."ai_document_versions" from "authenticated";

revoke trigger on table "public"."ai_document_versions" from "authenticated";

revoke truncate on table "public"."ai_document_versions" from "authenticated";

revoke update on table "public"."ai_document_versions" from "authenticated";

revoke delete on table "public"."ai_document_versions" from "service_role";

revoke insert on table "public"."ai_document_versions" from "service_role";

revoke references on table "public"."ai_document_versions" from "service_role";

revoke select on table "public"."ai_document_versions" from "service_role";

revoke trigger on table "public"."ai_document_versions" from "service_role";

revoke truncate on table "public"."ai_document_versions" from "service_role";

revoke update on table "public"."ai_document_versions" from "service_role";

revoke delete on table "public"."ai_documents" from "anon";

revoke insert on table "public"."ai_documents" from "anon";

revoke references on table "public"."ai_documents" from "anon";

revoke select on table "public"."ai_documents" from "anon";

revoke trigger on table "public"."ai_documents" from "anon";

revoke truncate on table "public"."ai_documents" from "anon";

revoke update on table "public"."ai_documents" from "anon";

revoke delete on table "public"."ai_documents" from "authenticated";

revoke insert on table "public"."ai_documents" from "authenticated";

revoke references on table "public"."ai_documents" from "authenticated";

revoke select on table "public"."ai_documents" from "authenticated";

revoke trigger on table "public"."ai_documents" from "authenticated";

revoke truncate on table "public"."ai_documents" from "authenticated";

revoke update on table "public"."ai_documents" from "authenticated";

revoke delete on table "public"."ai_documents" from "service_role";

revoke insert on table "public"."ai_documents" from "service_role";

revoke references on table "public"."ai_documents" from "service_role";

revoke select on table "public"."ai_documents" from "service_role";

revoke trigger on table "public"."ai_documents" from "service_role";

revoke truncate on table "public"."ai_documents" from "service_role";

revoke update on table "public"."ai_documents" from "service_role";

revoke delete on table "public"."ai_feedback_log" from "anon";

revoke insert on table "public"."ai_feedback_log" from "anon";

revoke references on table "public"."ai_feedback_log" from "anon";

revoke select on table "public"."ai_feedback_log" from "anon";

revoke trigger on table "public"."ai_feedback_log" from "anon";

revoke truncate on table "public"."ai_feedback_log" from "anon";

revoke update on table "public"."ai_feedback_log" from "anon";

revoke delete on table "public"."ai_feedback_log" from "authenticated";

revoke insert on table "public"."ai_feedback_log" from "authenticated";

revoke references on table "public"."ai_feedback_log" from "authenticated";

revoke select on table "public"."ai_feedback_log" from "authenticated";

revoke trigger on table "public"."ai_feedback_log" from "authenticated";

revoke truncate on table "public"."ai_feedback_log" from "authenticated";

revoke update on table "public"."ai_feedback_log" from "authenticated";

revoke delete on table "public"."ai_feedback_log" from "service_role";

revoke insert on table "public"."ai_feedback_log" from "service_role";

revoke references on table "public"."ai_feedback_log" from "service_role";

revoke select on table "public"."ai_feedback_log" from "service_role";

revoke trigger on table "public"."ai_feedback_log" from "service_role";

revoke truncate on table "public"."ai_feedback_log" from "service_role";

revoke update on table "public"."ai_feedback_log" from "service_role";

revoke delete on table "public"."ai_feedback_loop_log" from "anon";

revoke insert on table "public"."ai_feedback_loop_log" from "anon";

revoke references on table "public"."ai_feedback_loop_log" from "anon";

revoke select on table "public"."ai_feedback_loop_log" from "anon";

revoke trigger on table "public"."ai_feedback_loop_log" from "anon";

revoke truncate on table "public"."ai_feedback_loop_log" from "anon";

revoke update on table "public"."ai_feedback_loop_log" from "anon";

revoke delete on table "public"."ai_feedback_loop_log" from "authenticated";

revoke insert on table "public"."ai_feedback_loop_log" from "authenticated";

revoke references on table "public"."ai_feedback_loop_log" from "authenticated";

revoke select on table "public"."ai_feedback_loop_log" from "authenticated";

revoke trigger on table "public"."ai_feedback_loop_log" from "authenticated";

revoke truncate on table "public"."ai_feedback_loop_log" from "authenticated";

revoke update on table "public"."ai_feedback_loop_log" from "authenticated";

revoke delete on table "public"."ai_feedback_loop_log" from "service_role";

revoke insert on table "public"."ai_feedback_loop_log" from "service_role";

revoke references on table "public"."ai_feedback_loop_log" from "service_role";

revoke select on table "public"."ai_feedback_loop_log" from "service_role";

revoke trigger on table "public"."ai_feedback_loop_log" from "service_role";

revoke truncate on table "public"."ai_feedback_loop_log" from "service_role";

revoke update on table "public"."ai_feedback_loop_log" from "service_role";

revoke delete on table "public"."ai_feedback_submissions" from "anon";

revoke insert on table "public"."ai_feedback_submissions" from "anon";

revoke references on table "public"."ai_feedback_submissions" from "anon";

revoke select on table "public"."ai_feedback_submissions" from "anon";

revoke trigger on table "public"."ai_feedback_submissions" from "anon";

revoke truncate on table "public"."ai_feedback_submissions" from "anon";

revoke update on table "public"."ai_feedback_submissions" from "anon";

revoke delete on table "public"."ai_feedback_submissions" from "authenticated";

revoke insert on table "public"."ai_feedback_submissions" from "authenticated";

revoke references on table "public"."ai_feedback_submissions" from "authenticated";

revoke select on table "public"."ai_feedback_submissions" from "authenticated";

revoke trigger on table "public"."ai_feedback_submissions" from "authenticated";

revoke truncate on table "public"."ai_feedback_submissions" from "authenticated";

revoke update on table "public"."ai_feedback_submissions" from "authenticated";

revoke delete on table "public"."ai_feedback_submissions" from "service_role";

revoke insert on table "public"."ai_feedback_submissions" from "service_role";

revoke references on table "public"."ai_feedback_submissions" from "service_role";

revoke select on table "public"."ai_feedback_submissions" from "service_role";

revoke trigger on table "public"."ai_feedback_submissions" from "service_role";

revoke truncate on table "public"."ai_feedback_submissions" from "service_role";

revoke update on table "public"."ai_feedback_submissions" from "service_role";

revoke delete on table "public"."ai_learning_patterns" from "anon";

revoke insert on table "public"."ai_learning_patterns" from "anon";

revoke references on table "public"."ai_learning_patterns" from "anon";

revoke select on table "public"."ai_learning_patterns" from "anon";

revoke trigger on table "public"."ai_learning_patterns" from "anon";

revoke truncate on table "public"."ai_learning_patterns" from "anon";

revoke update on table "public"."ai_learning_patterns" from "anon";

revoke delete on table "public"."ai_learning_patterns" from "authenticated";

revoke insert on table "public"."ai_learning_patterns" from "authenticated";

revoke references on table "public"."ai_learning_patterns" from "authenticated";

revoke select on table "public"."ai_learning_patterns" from "authenticated";

revoke trigger on table "public"."ai_learning_patterns" from "authenticated";

revoke truncate on table "public"."ai_learning_patterns" from "authenticated";

revoke update on table "public"."ai_learning_patterns" from "authenticated";

revoke delete on table "public"."ai_learning_patterns" from "service_role";

revoke insert on table "public"."ai_learning_patterns" from "service_role";

revoke references on table "public"."ai_learning_patterns" from "service_role";

revoke select on table "public"."ai_learning_patterns" from "service_role";

revoke trigger on table "public"."ai_learning_patterns" from "service_role";

revoke truncate on table "public"."ai_learning_patterns" from "service_role";

revoke update on table "public"."ai_learning_patterns" from "service_role";

revoke delete on table "public"."ai_upload_audit" from "anon";

revoke insert on table "public"."ai_upload_audit" from "anon";

revoke references on table "public"."ai_upload_audit" from "anon";

revoke select on table "public"."ai_upload_audit" from "anon";

revoke trigger on table "public"."ai_upload_audit" from "anon";

revoke truncate on table "public"."ai_upload_audit" from "anon";

revoke update on table "public"."ai_upload_audit" from "anon";

revoke delete on table "public"."ai_upload_audit" from "authenticated";

revoke insert on table "public"."ai_upload_audit" from "authenticated";

revoke references on table "public"."ai_upload_audit" from "authenticated";

revoke select on table "public"."ai_upload_audit" from "authenticated";

revoke trigger on table "public"."ai_upload_audit" from "authenticated";

revoke truncate on table "public"."ai_upload_audit" from "authenticated";

revoke update on table "public"."ai_upload_audit" from "authenticated";

revoke delete on table "public"."ai_upload_audit" from "service_role";

revoke insert on table "public"."ai_upload_audit" from "service_role";

revoke references on table "public"."ai_upload_audit" from "service_role";

revoke select on table "public"."ai_upload_audit" from "service_role";

revoke trigger on table "public"."ai_upload_audit" from "service_role";

revoke truncate on table "public"."ai_upload_audit" from "service_role";

revoke update on table "public"."ai_upload_audit" from "service_role";

revoke delete on table "public"."api_usage_log" from "anon";

revoke insert on table "public"."api_usage_log" from "anon";

revoke references on table "public"."api_usage_log" from "anon";

revoke select on table "public"."api_usage_log" from "anon";

revoke trigger on table "public"."api_usage_log" from "anon";

revoke truncate on table "public"."api_usage_log" from "anon";

revoke update on table "public"."api_usage_log" from "anon";

revoke delete on table "public"."api_usage_log" from "authenticated";

revoke insert on table "public"."api_usage_log" from "authenticated";

revoke references on table "public"."api_usage_log" from "authenticated";

revoke select on table "public"."api_usage_log" from "authenticated";

revoke trigger on table "public"."api_usage_log" from "authenticated";

revoke truncate on table "public"."api_usage_log" from "authenticated";

revoke update on table "public"."api_usage_log" from "authenticated";

revoke delete on table "public"."api_usage_log" from "service_role";

revoke insert on table "public"."api_usage_log" from "service_role";

revoke references on table "public"."api_usage_log" from "service_role";

revoke select on table "public"."api_usage_log" from "service_role";

revoke trigger on table "public"."api_usage_log" from "service_role";

revoke truncate on table "public"."api_usage_log" from "service_role";

revoke update on table "public"."api_usage_log" from "service_role";

revoke delete on table "public"."approval_requests" from "anon";

revoke insert on table "public"."approval_requests" from "anon";

revoke references on table "public"."approval_requests" from "anon";

revoke select on table "public"."approval_requests" from "anon";

revoke trigger on table "public"."approval_requests" from "anon";

revoke truncate on table "public"."approval_requests" from "anon";

revoke update on table "public"."approval_requests" from "anon";

revoke delete on table "public"."approval_requests" from "authenticated";

revoke insert on table "public"."approval_requests" from "authenticated";

revoke references on table "public"."approval_requests" from "authenticated";

revoke select on table "public"."approval_requests" from "authenticated";

revoke trigger on table "public"."approval_requests" from "authenticated";

revoke truncate on table "public"."approval_requests" from "authenticated";

revoke update on table "public"."approval_requests" from "authenticated";

revoke delete on table "public"."approval_requests" from "service_role";

revoke insert on table "public"."approval_requests" from "service_role";

revoke references on table "public"."approval_requests" from "service_role";

revoke select on table "public"."approval_requests" from "service_role";

revoke trigger on table "public"."approval_requests" from "service_role";

revoke truncate on table "public"."approval_requests" from "service_role";

revoke update on table "public"."approval_requests" from "service_role";

revoke delete on table "public"."approved_chunks_cache" from "anon";

revoke insert on table "public"."approved_chunks_cache" from "anon";

revoke references on table "public"."approved_chunks_cache" from "anon";

revoke select on table "public"."approved_chunks_cache" from "anon";

revoke trigger on table "public"."approved_chunks_cache" from "anon";

revoke truncate on table "public"."approved_chunks_cache" from "anon";

revoke update on table "public"."approved_chunks_cache" from "anon";

revoke delete on table "public"."approved_chunks_cache" from "authenticated";

revoke insert on table "public"."approved_chunks_cache" from "authenticated";

revoke references on table "public"."approved_chunks_cache" from "authenticated";

revoke select on table "public"."approved_chunks_cache" from "authenticated";

revoke trigger on table "public"."approved_chunks_cache" from "authenticated";

revoke truncate on table "public"."approved_chunks_cache" from "authenticated";

revoke update on table "public"."approved_chunks_cache" from "authenticated";

revoke delete on table "public"."approved_chunks_cache" from "service_role";

revoke insert on table "public"."approved_chunks_cache" from "service_role";

revoke references on table "public"."approved_chunks_cache" from "service_role";

revoke select on table "public"."approved_chunks_cache" from "service_role";

revoke trigger on table "public"."approved_chunks_cache" from "service_role";

revoke truncate on table "public"."approved_chunks_cache" from "service_role";

revoke update on table "public"."approved_chunks_cache" from "service_role";

revoke delete on table "public"."assessment_scores" from "anon";

revoke insert on table "public"."assessment_scores" from "anon";

revoke references on table "public"."assessment_scores" from "anon";

revoke select on table "public"."assessment_scores" from "anon";

revoke trigger on table "public"."assessment_scores" from "anon";

revoke truncate on table "public"."assessment_scores" from "anon";

revoke update on table "public"."assessment_scores" from "anon";

revoke delete on table "public"."assessment_scores" from "authenticated";

revoke insert on table "public"."assessment_scores" from "authenticated";

revoke references on table "public"."assessment_scores" from "authenticated";

revoke select on table "public"."assessment_scores" from "authenticated";

revoke trigger on table "public"."assessment_scores" from "authenticated";

revoke truncate on table "public"."assessment_scores" from "authenticated";

revoke update on table "public"."assessment_scores" from "authenticated";

revoke delete on table "public"."assessment_scores" from "service_role";

revoke insert on table "public"."assessment_scores" from "service_role";

revoke references on table "public"."assessment_scores" from "service_role";

revoke select on table "public"."assessment_scores" from "service_role";

revoke trigger on table "public"."assessment_scores" from "service_role";

revoke truncate on table "public"."assessment_scores" from "service_role";

revoke update on table "public"."assessment_scores" from "service_role";

revoke delete on table "public"."assessments" from "anon";

revoke insert on table "public"."assessments" from "anon";

revoke references on table "public"."assessments" from "anon";

revoke select on table "public"."assessments" from "anon";

revoke trigger on table "public"."assessments" from "anon";

revoke truncate on table "public"."assessments" from "anon";

revoke update on table "public"."assessments" from "anon";

revoke delete on table "public"."assessments" from "authenticated";

revoke insert on table "public"."assessments" from "authenticated";

revoke references on table "public"."assessments" from "authenticated";

revoke select on table "public"."assessments" from "authenticated";

revoke trigger on table "public"."assessments" from "authenticated";

revoke truncate on table "public"."assessments" from "authenticated";

revoke update on table "public"."assessments" from "authenticated";

revoke delete on table "public"."assessments" from "service_role";

revoke insert on table "public"."assessments" from "service_role";

revoke references on table "public"."assessments" from "service_role";

revoke select on table "public"."assessments" from "service_role";

revoke trigger on table "public"."assessments" from "service_role";

revoke truncate on table "public"."assessments" from "service_role";

revoke update on table "public"."assessments" from "service_role";

revoke delete on table "public"."audit_trail" from "anon";

revoke insert on table "public"."audit_trail" from "anon";

revoke references on table "public"."audit_trail" from "anon";

revoke select on table "public"."audit_trail" from "anon";

revoke trigger on table "public"."audit_trail" from "anon";

revoke truncate on table "public"."audit_trail" from "anon";

revoke update on table "public"."audit_trail" from "anon";

revoke delete on table "public"."audit_trail" from "authenticated";

revoke insert on table "public"."audit_trail" from "authenticated";

revoke references on table "public"."audit_trail" from "authenticated";

revoke select on table "public"."audit_trail" from "authenticated";

revoke trigger on table "public"."audit_trail" from "authenticated";

revoke truncate on table "public"."audit_trail" from "authenticated";

revoke update on table "public"."audit_trail" from "authenticated";

revoke delete on table "public"."audit_trail" from "service_role";

revoke insert on table "public"."audit_trail" from "service_role";

revoke references on table "public"."audit_trail" from "service_role";

revoke select on table "public"."audit_trail" from "service_role";

revoke trigger on table "public"."audit_trail" from "service_role";

revoke truncate on table "public"."audit_trail" from "service_role";

revoke update on table "public"."audit_trail" from "service_role";

revoke delete on table "public"."auditor_assignments" from "anon";

revoke insert on table "public"."auditor_assignments" from "anon";

revoke references on table "public"."auditor_assignments" from "anon";

revoke select on table "public"."auditor_assignments" from "anon";

revoke trigger on table "public"."auditor_assignments" from "anon";

revoke truncate on table "public"."auditor_assignments" from "anon";

revoke update on table "public"."auditor_assignments" from "anon";

revoke delete on table "public"."auditor_assignments" from "authenticated";

revoke insert on table "public"."auditor_assignments" from "authenticated";

revoke references on table "public"."auditor_assignments" from "authenticated";

revoke select on table "public"."auditor_assignments" from "authenticated";

revoke trigger on table "public"."auditor_assignments" from "authenticated";

revoke truncate on table "public"."auditor_assignments" from "authenticated";

revoke update on table "public"."auditor_assignments" from "authenticated";

revoke delete on table "public"."auditor_assignments" from "service_role";

revoke insert on table "public"."auditor_assignments" from "service_role";

revoke references on table "public"."auditor_assignments" from "service_role";

revoke select on table "public"."auditor_assignments" from "service_role";

revoke trigger on table "public"."auditor_assignments" from "service_role";

revoke truncate on table "public"."auditor_assignments" from "service_role";

revoke update on table "public"."auditor_assignments" from "service_role";

revoke delete on table "public"."backoffice_admins" from "anon";

revoke insert on table "public"."backoffice_admins" from "anon";

revoke references on table "public"."backoffice_admins" from "anon";

revoke select on table "public"."backoffice_admins" from "anon";

revoke trigger on table "public"."backoffice_admins" from "anon";

revoke truncate on table "public"."backoffice_admins" from "anon";

revoke update on table "public"."backoffice_admins" from "anon";

revoke delete on table "public"."backoffice_admins" from "authenticated";

revoke insert on table "public"."backoffice_admins" from "authenticated";

revoke references on table "public"."backoffice_admins" from "authenticated";

revoke select on table "public"."backoffice_admins" from "authenticated";

revoke trigger on table "public"."backoffice_admins" from "authenticated";

revoke truncate on table "public"."backoffice_admins" from "authenticated";

revoke update on table "public"."backoffice_admins" from "authenticated";

revoke delete on table "public"."backoffice_admins" from "service_role";

revoke insert on table "public"."backoffice_admins" from "service_role";

revoke references on table "public"."backoffice_admins" from "service_role";

revoke select on table "public"."backoffice_admins" from "service_role";

revoke trigger on table "public"."backoffice_admins" from "service_role";

revoke truncate on table "public"."backoffice_admins" from "service_role";

revoke update on table "public"."backoffice_admins" from "service_role";

revoke delete on table "public"."chunks" from "anon";

revoke insert on table "public"."chunks" from "anon";

revoke references on table "public"."chunks" from "anon";

revoke select on table "public"."chunks" from "anon";

revoke trigger on table "public"."chunks" from "anon";

revoke truncate on table "public"."chunks" from "anon";

revoke update on table "public"."chunks" from "anon";

revoke delete on table "public"."chunks" from "authenticated";

revoke insert on table "public"."chunks" from "authenticated";

revoke references on table "public"."chunks" from "authenticated";

revoke select on table "public"."chunks" from "authenticated";

revoke trigger on table "public"."chunks" from "authenticated";

revoke truncate on table "public"."chunks" from "authenticated";

revoke update on table "public"."chunks" from "authenticated";

revoke delete on table "public"."chunks" from "service_role";

revoke insert on table "public"."chunks" from "service_role";

revoke references on table "public"."chunks" from "service_role";

revoke select on table "public"."chunks" from "service_role";

revoke trigger on table "public"."chunks" from "service_role";

revoke truncate on table "public"."chunks" from "service_role";

revoke update on table "public"."chunks" from "service_role";

revoke delete on table "public"."conversation_history" from "anon";

revoke insert on table "public"."conversation_history" from "anon";

revoke references on table "public"."conversation_history" from "anon";

revoke select on table "public"."conversation_history" from "anon";

revoke trigger on table "public"."conversation_history" from "anon";

revoke truncate on table "public"."conversation_history" from "anon";

revoke update on table "public"."conversation_history" from "anon";

revoke delete on table "public"."conversation_history" from "authenticated";

revoke insert on table "public"."conversation_history" from "authenticated";

revoke references on table "public"."conversation_history" from "authenticated";

revoke select on table "public"."conversation_history" from "authenticated";

revoke trigger on table "public"."conversation_history" from "authenticated";

revoke truncate on table "public"."conversation_history" from "authenticated";

revoke update on table "public"."conversation_history" from "authenticated";

revoke delete on table "public"."conversation_history" from "service_role";

revoke insert on table "public"."conversation_history" from "service_role";

revoke references on table "public"."conversation_history" from "service_role";

revoke select on table "public"."conversation_history" from "service_role";

revoke trigger on table "public"."conversation_history" from "service_role";

revoke truncate on table "public"."conversation_history" from "service_role";

revoke update on table "public"."conversation_history" from "service_role";

revoke delete on table "public"."criteria" from "anon";

revoke insert on table "public"."criteria" from "anon";

revoke references on table "public"."criteria" from "anon";

revoke select on table "public"."criteria" from "anon";

revoke trigger on table "public"."criteria" from "anon";

revoke truncate on table "public"."criteria" from "anon";

revoke update on table "public"."criteria" from "anon";

revoke delete on table "public"."criteria" from "authenticated";

revoke insert on table "public"."criteria" from "authenticated";

revoke references on table "public"."criteria" from "authenticated";

revoke select on table "public"."criteria" from "authenticated";

revoke trigger on table "public"."criteria" from "authenticated";

revoke truncate on table "public"."criteria" from "authenticated";

revoke update on table "public"."criteria" from "authenticated";

revoke delete on table "public"."criteria" from "service_role";

revoke insert on table "public"."criteria" from "service_role";

revoke references on table "public"."criteria" from "service_role";

revoke select on table "public"."criteria" from "service_role";

revoke trigger on table "public"."criteria" from "service_role";

revoke truncate on table "public"."criteria" from "service_role";

revoke update on table "public"."criteria" from "service_role";

revoke delete on table "public"."criteria_deferrals" from "anon";

revoke insert on table "public"."criteria_deferrals" from "anon";

revoke references on table "public"."criteria_deferrals" from "anon";

revoke select on table "public"."criteria_deferrals" from "anon";

revoke trigger on table "public"."criteria_deferrals" from "anon";

revoke truncate on table "public"."criteria_deferrals" from "anon";

revoke update on table "public"."criteria_deferrals" from "anon";

revoke delete on table "public"."criteria_deferrals" from "authenticated";

revoke insert on table "public"."criteria_deferrals" from "authenticated";

revoke references on table "public"."criteria_deferrals" from "authenticated";

revoke select on table "public"."criteria_deferrals" from "authenticated";

revoke trigger on table "public"."criteria_deferrals" from "authenticated";

revoke truncate on table "public"."criteria_deferrals" from "authenticated";

revoke update on table "public"."criteria_deferrals" from "authenticated";

revoke delete on table "public"."criteria_deferrals" from "service_role";

revoke insert on table "public"."criteria_deferrals" from "service_role";

revoke references on table "public"."criteria_deferrals" from "service_role";

revoke select on table "public"."criteria_deferrals" from "service_role";

revoke trigger on table "public"."criteria_deferrals" from "service_role";

revoke truncate on table "public"."criteria_deferrals" from "service_role";

revoke update on table "public"."criteria_deferrals" from "service_role";

revoke delete on table "public"."criteria_edit_history" from "anon";

revoke insert on table "public"."criteria_edit_history" from "anon";

revoke references on table "public"."criteria_edit_history" from "anon";

revoke select on table "public"."criteria_edit_history" from "anon";

revoke trigger on table "public"."criteria_edit_history" from "anon";

revoke truncate on table "public"."criteria_edit_history" from "anon";

revoke update on table "public"."criteria_edit_history" from "anon";

revoke delete on table "public"."criteria_edit_history" from "authenticated";

revoke insert on table "public"."criteria_edit_history" from "authenticated";

revoke references on table "public"."criteria_edit_history" from "authenticated";

revoke select on table "public"."criteria_edit_history" from "authenticated";

revoke trigger on table "public"."criteria_edit_history" from "authenticated";

revoke truncate on table "public"."criteria_edit_history" from "authenticated";

revoke update on table "public"."criteria_edit_history" from "authenticated";

revoke delete on table "public"."criteria_edit_history" from "service_role";

revoke insert on table "public"."criteria_edit_history" from "service_role";

revoke references on table "public"."criteria_edit_history" from "service_role";

revoke select on table "public"."criteria_edit_history" from "service_role";

revoke trigger on table "public"."criteria_edit_history" from "service_role";

revoke truncate on table "public"."criteria_edit_history" from "service_role";

revoke update on table "public"."criteria_edit_history" from "service_role";

revoke delete on table "public"."criteria_rejections" from "anon";

revoke insert on table "public"."criteria_rejections" from "anon";

revoke references on table "public"."criteria_rejections" from "anon";

revoke select on table "public"."criteria_rejections" from "anon";

revoke trigger on table "public"."criteria_rejections" from "anon";

revoke truncate on table "public"."criteria_rejections" from "anon";

revoke update on table "public"."criteria_rejections" from "anon";

revoke delete on table "public"."criteria_rejections" from "authenticated";

revoke insert on table "public"."criteria_rejections" from "authenticated";

revoke references on table "public"."criteria_rejections" from "authenticated";

revoke select on table "public"."criteria_rejections" from "authenticated";

revoke trigger on table "public"."criteria_rejections" from "authenticated";

revoke truncate on table "public"."criteria_rejections" from "authenticated";

revoke update on table "public"."criteria_rejections" from "authenticated";

revoke delete on table "public"."criteria_rejections" from "service_role";

revoke insert on table "public"."criteria_rejections" from "service_role";

revoke references on table "public"."criteria_rejections" from "service_role";

revoke select on table "public"."criteria_rejections" from "service_role";

revoke trigger on table "public"."criteria_rejections" from "service_role";

revoke truncate on table "public"."criteria_rejections" from "service_role";

revoke update on table "public"."criteria_rejections" from "service_role";

revoke delete on table "public"."cross_org_tracking" from "anon";

revoke insert on table "public"."cross_org_tracking" from "anon";

revoke references on table "public"."cross_org_tracking" from "anon";

revoke select on table "public"."cross_org_tracking" from "anon";

revoke trigger on table "public"."cross_org_tracking" from "anon";

revoke truncate on table "public"."cross_org_tracking" from "anon";

revoke update on table "public"."cross_org_tracking" from "anon";

revoke delete on table "public"."cross_org_tracking" from "authenticated";

revoke insert on table "public"."cross_org_tracking" from "authenticated";

revoke references on table "public"."cross_org_tracking" from "authenticated";

revoke select on table "public"."cross_org_tracking" from "authenticated";

revoke trigger on table "public"."cross_org_tracking" from "authenticated";

revoke truncate on table "public"."cross_org_tracking" from "authenticated";

revoke update on table "public"."cross_org_tracking" from "authenticated";

revoke delete on table "public"."cross_org_tracking" from "service_role";

revoke insert on table "public"."cross_org_tracking" from "service_role";

revoke references on table "public"."cross_org_tracking" from "service_role";

revoke select on table "public"."cross_org_tracking" from "service_role";

revoke trigger on table "public"."cross_org_tracking" from "service_role";

revoke truncate on table "public"."cross_org_tracking" from "service_role";

revoke update on table "public"."cross_org_tracking" from "service_role";

revoke delete on table "public"."data_source_sync_logs" from "anon";

revoke insert on table "public"."data_source_sync_logs" from "anon";

revoke references on table "public"."data_source_sync_logs" from "anon";

revoke select on table "public"."data_source_sync_logs" from "anon";

revoke trigger on table "public"."data_source_sync_logs" from "anon";

revoke truncate on table "public"."data_source_sync_logs" from "anon";

revoke update on table "public"."data_source_sync_logs" from "anon";

revoke delete on table "public"."data_source_sync_logs" from "authenticated";

revoke insert on table "public"."data_source_sync_logs" from "authenticated";

revoke references on table "public"."data_source_sync_logs" from "authenticated";

revoke select on table "public"."data_source_sync_logs" from "authenticated";

revoke trigger on table "public"."data_source_sync_logs" from "authenticated";

revoke truncate on table "public"."data_source_sync_logs" from "authenticated";

revoke update on table "public"."data_source_sync_logs" from "authenticated";

revoke delete on table "public"."data_source_sync_logs" from "service_role";

revoke insert on table "public"."data_source_sync_logs" from "service_role";

revoke references on table "public"."data_source_sync_logs" from "service_role";

revoke select on table "public"."data_source_sync_logs" from "service_role";

revoke trigger on table "public"."data_source_sync_logs" from "service_role";

revoke truncate on table "public"."data_source_sync_logs" from "service_role";

revoke update on table "public"."data_source_sync_logs" from "service_role";

revoke delete on table "public"."data_sources" from "anon";

revoke insert on table "public"."data_sources" from "anon";

revoke references on table "public"."data_sources" from "anon";

revoke select on table "public"."data_sources" from "anon";

revoke trigger on table "public"."data_sources" from "anon";

revoke truncate on table "public"."data_sources" from "anon";

revoke update on table "public"."data_sources" from "anon";

revoke delete on table "public"."data_sources" from "authenticated";

revoke insert on table "public"."data_sources" from "authenticated";

revoke references on table "public"."data_sources" from "authenticated";

revoke select on table "public"."data_sources" from "authenticated";

revoke trigger on table "public"."data_sources" from "authenticated";

revoke truncate on table "public"."data_sources" from "authenticated";

revoke update on table "public"."data_sources" from "authenticated";

revoke delete on table "public"."data_sources" from "service_role";

revoke insert on table "public"."data_sources" from "service_role";

revoke references on table "public"."data_sources" from "service_role";

revoke select on table "public"."data_sources" from "service_role";

revoke trigger on table "public"."data_sources" from "service_role";

revoke truncate on table "public"."data_sources" from "service_role";

revoke update on table "public"."data_sources" from "service_role";

revoke delete on table "public"."deduplication_reports" from "anon";

revoke insert on table "public"."deduplication_reports" from "anon";

revoke references on table "public"."deduplication_reports" from "anon";

revoke select on table "public"."deduplication_reports" from "anon";

revoke trigger on table "public"."deduplication_reports" from "anon";

revoke truncate on table "public"."deduplication_reports" from "anon";

revoke update on table "public"."deduplication_reports" from "anon";

revoke delete on table "public"."deduplication_reports" from "authenticated";

revoke insert on table "public"."deduplication_reports" from "authenticated";

revoke references on table "public"."deduplication_reports" from "authenticated";

revoke select on table "public"."deduplication_reports" from "authenticated";

revoke trigger on table "public"."deduplication_reports" from "authenticated";

revoke truncate on table "public"."deduplication_reports" from "authenticated";

revoke update on table "public"."deduplication_reports" from "authenticated";

revoke delete on table "public"."deduplication_reports" from "service_role";

revoke insert on table "public"."deduplication_reports" from "service_role";

revoke references on table "public"."deduplication_reports" from "service_role";

revoke select on table "public"."deduplication_reports" from "service_role";

revoke trigger on table "public"."deduplication_reports" from "service_role";

revoke truncate on table "public"."deduplication_reports" from "service_role";

revoke update on table "public"."deduplication_reports" from "service_role";

revoke delete on table "public"."discount_codes" from "anon";

revoke insert on table "public"."discount_codes" from "anon";

revoke references on table "public"."discount_codes" from "anon";

revoke select on table "public"."discount_codes" from "anon";

revoke trigger on table "public"."discount_codes" from "anon";

revoke truncate on table "public"."discount_codes" from "anon";

revoke update on table "public"."discount_codes" from "anon";

revoke delete on table "public"."discount_codes" from "authenticated";

revoke insert on table "public"."discount_codes" from "authenticated";

revoke references on table "public"."discount_codes" from "authenticated";

revoke select on table "public"."discount_codes" from "authenticated";

revoke trigger on table "public"."discount_codes" from "authenticated";

revoke truncate on table "public"."discount_codes" from "authenticated";

revoke update on table "public"."discount_codes" from "authenticated";

revoke delete on table "public"."discount_codes" from "service_role";

revoke insert on table "public"."discount_codes" from "service_role";

revoke references on table "public"."discount_codes" from "service_role";

revoke select on table "public"."discount_codes" from "service_role";

revoke trigger on table "public"."discount_codes" from "service_role";

revoke truncate on table "public"."discount_codes" from "service_role";

revoke update on table "public"."discount_codes" from "service_role";

revoke delete on table "public"."document_types" from "anon";

revoke insert on table "public"."document_types" from "anon";

revoke references on table "public"."document_types" from "anon";

revoke select on table "public"."document_types" from "anon";

revoke trigger on table "public"."document_types" from "anon";

revoke truncate on table "public"."document_types" from "anon";

revoke update on table "public"."document_types" from "anon";

revoke delete on table "public"."document_types" from "authenticated";

revoke insert on table "public"."document_types" from "authenticated";

revoke references on table "public"."document_types" from "authenticated";

revoke select on table "public"."document_types" from "authenticated";

revoke trigger on table "public"."document_types" from "authenticated";

revoke truncate on table "public"."document_types" from "authenticated";

revoke update on table "public"."document_types" from "authenticated";

revoke delete on table "public"."document_types" from "service_role";

revoke insert on table "public"."document_types" from "service_role";

revoke references on table "public"."document_types" from "service_role";

revoke select on table "public"."document_types" from "service_role";

revoke trigger on table "public"."document_types" from "service_role";

revoke truncate on table "public"."document_types" from "service_role";

revoke update on table "public"."document_types" from "service_role";

revoke delete on table "public"."domains" from "anon";

revoke insert on table "public"."domains" from "anon";

revoke references on table "public"."domains" from "anon";

revoke select on table "public"."domains" from "anon";

revoke trigger on table "public"."domains" from "anon";

revoke truncate on table "public"."domains" from "anon";

revoke update on table "public"."domains" from "anon";

revoke delete on table "public"."domains" from "authenticated";

revoke insert on table "public"."domains" from "authenticated";

revoke references on table "public"."domains" from "authenticated";

revoke select on table "public"."domains" from "authenticated";

revoke trigger on table "public"."domains" from "authenticated";

revoke truncate on table "public"."domains" from "authenticated";

revoke update on table "public"."domains" from "authenticated";

revoke delete on table "public"."domains" from "service_role";

revoke insert on table "public"."domains" from "service_role";

revoke references on table "public"."domains" from "service_role";

revoke select on table "public"."domains" from "service_role";

revoke trigger on table "public"."domains" from "service_role";

revoke truncate on table "public"."domains" from "service_role";

revoke update on table "public"."domains" from "service_role";

revoke delete on table "public"."evidence" from "anon";

revoke insert on table "public"."evidence" from "anon";

revoke references on table "public"."evidence" from "anon";

revoke select on table "public"."evidence" from "anon";

revoke trigger on table "public"."evidence" from "anon";

revoke truncate on table "public"."evidence" from "anon";

revoke update on table "public"."evidence" from "anon";

revoke delete on table "public"."evidence" from "authenticated";

revoke insert on table "public"."evidence" from "authenticated";

revoke references on table "public"."evidence" from "authenticated";

revoke select on table "public"."evidence" from "authenticated";

revoke trigger on table "public"."evidence" from "authenticated";

revoke truncate on table "public"."evidence" from "authenticated";

revoke update on table "public"."evidence" from "authenticated";

revoke delete on table "public"."evidence" from "service_role";

revoke insert on table "public"."evidence" from "service_role";

revoke references on table "public"."evidence" from "service_role";

revoke select on table "public"."evidence" from "service_role";

revoke trigger on table "public"."evidence" from "service_role";

revoke truncate on table "public"."evidence" from "service_role";

revoke update on table "public"."evidence" from "service_role";

revoke delete on table "public"."evidence_submissions" from "anon";

revoke insert on table "public"."evidence_submissions" from "anon";

revoke references on table "public"."evidence_submissions" from "anon";

revoke select on table "public"."evidence_submissions" from "anon";

revoke trigger on table "public"."evidence_submissions" from "anon";

revoke truncate on table "public"."evidence_submissions" from "anon";

revoke update on table "public"."evidence_submissions" from "anon";

revoke delete on table "public"."evidence_submissions" from "authenticated";

revoke insert on table "public"."evidence_submissions" from "authenticated";

revoke references on table "public"."evidence_submissions" from "authenticated";

revoke select on table "public"."evidence_submissions" from "authenticated";

revoke trigger on table "public"."evidence_submissions" from "authenticated";

revoke truncate on table "public"."evidence_submissions" from "authenticated";

revoke update on table "public"."evidence_submissions" from "authenticated";

revoke delete on table "public"."evidence_submissions" from "service_role";

revoke insert on table "public"."evidence_submissions" from "service_role";

revoke references on table "public"."evidence_submissions" from "service_role";

revoke select on table "public"."evidence_submissions" from "service_role";

revoke trigger on table "public"."evidence_submissions" from "service_role";

revoke truncate on table "public"."evidence_submissions" from "service_role";

revoke update on table "public"."evidence_submissions" from "service_role";

revoke delete on table "public"."external_insights" from "anon";

revoke insert on table "public"."external_insights" from "anon";

revoke references on table "public"."external_insights" from "anon";

revoke select on table "public"."external_insights" from "anon";

revoke trigger on table "public"."external_insights" from "anon";

revoke truncate on table "public"."external_insights" from "anon";

revoke update on table "public"."external_insights" from "anon";

revoke delete on table "public"."external_insights" from "authenticated";

revoke insert on table "public"."external_insights" from "authenticated";

revoke references on table "public"."external_insights" from "authenticated";

revoke select on table "public"."external_insights" from "authenticated";

revoke trigger on table "public"."external_insights" from "authenticated";

revoke truncate on table "public"."external_insights" from "authenticated";

revoke update on table "public"."external_insights" from "authenticated";

revoke delete on table "public"."external_insights" from "service_role";

revoke insert on table "public"."external_insights" from "service_role";

revoke references on table "public"."external_insights" from "service_role";

revoke select on table "public"."external_insights" from "service_role";

revoke trigger on table "public"."external_insights" from "service_role";

revoke truncate on table "public"."external_insights" from "service_role";

revoke update on table "public"."external_insights" from "service_role";

revoke delete on table "public"."feedback_retraining_weights" from "anon";

revoke insert on table "public"."feedback_retraining_weights" from "anon";

revoke references on table "public"."feedback_retraining_weights" from "anon";

revoke select on table "public"."feedback_retraining_weights" from "anon";

revoke trigger on table "public"."feedback_retraining_weights" from "anon";

revoke truncate on table "public"."feedback_retraining_weights" from "anon";

revoke update on table "public"."feedback_retraining_weights" from "anon";

revoke delete on table "public"."feedback_retraining_weights" from "authenticated";

revoke insert on table "public"."feedback_retraining_weights" from "authenticated";

revoke references on table "public"."feedback_retraining_weights" from "authenticated";

revoke select on table "public"."feedback_retraining_weights" from "authenticated";

revoke trigger on table "public"."feedback_retraining_weights" from "authenticated";

revoke truncate on table "public"."feedback_retraining_weights" from "authenticated";

revoke update on table "public"."feedback_retraining_weights" from "authenticated";

revoke delete on table "public"."feedback_retraining_weights" from "service_role";

revoke insert on table "public"."feedback_retraining_weights" from "service_role";

revoke references on table "public"."feedback_retraining_weights" from "service_role";

revoke select on table "public"."feedback_retraining_weights" from "service_role";

revoke trigger on table "public"."feedback_retraining_weights" from "service_role";

revoke truncate on table "public"."feedback_retraining_weights" from "service_role";

revoke update on table "public"."feedback_retraining_weights" from "service_role";

revoke delete on table "public"."gap_tickets" from "anon";

revoke insert on table "public"."gap_tickets" from "anon";

revoke references on table "public"."gap_tickets" from "anon";

revoke select on table "public"."gap_tickets" from "anon";

revoke trigger on table "public"."gap_tickets" from "anon";

revoke truncate on table "public"."gap_tickets" from "anon";

revoke update on table "public"."gap_tickets" from "anon";

revoke delete on table "public"."gap_tickets" from "authenticated";

revoke insert on table "public"."gap_tickets" from "authenticated";

revoke references on table "public"."gap_tickets" from "authenticated";

revoke select on table "public"."gap_tickets" from "authenticated";

revoke trigger on table "public"."gap_tickets" from "authenticated";

revoke truncate on table "public"."gap_tickets" from "authenticated";

revoke update on table "public"."gap_tickets" from "authenticated";

revoke delete on table "public"."gap_tickets" from "service_role";

revoke insert on table "public"."gap_tickets" from "service_role";

revoke references on table "public"."gap_tickets" from "service_role";

revoke select on table "public"."gap_tickets" from "service_role";

revoke trigger on table "public"."gap_tickets" from "service_role";

revoke truncate on table "public"."gap_tickets" from "service_role";

revoke update on table "public"."gap_tickets" from "service_role";

revoke delete on table "public"."human_approval_workflows" from "anon";

revoke insert on table "public"."human_approval_workflows" from "anon";

revoke references on table "public"."human_approval_workflows" from "anon";

revoke select on table "public"."human_approval_workflows" from "anon";

revoke trigger on table "public"."human_approval_workflows" from "anon";

revoke truncate on table "public"."human_approval_workflows" from "anon";

revoke update on table "public"."human_approval_workflows" from "anon";

revoke delete on table "public"."human_approval_workflows" from "authenticated";

revoke insert on table "public"."human_approval_workflows" from "authenticated";

revoke references on table "public"."human_approval_workflows" from "authenticated";

revoke select on table "public"."human_approval_workflows" from "authenticated";

revoke trigger on table "public"."human_approval_workflows" from "authenticated";

revoke truncate on table "public"."human_approval_workflows" from "authenticated";

revoke update on table "public"."human_approval_workflows" from "authenticated";

revoke delete on table "public"."human_approval_workflows" from "service_role";

revoke insert on table "public"."human_approval_workflows" from "service_role";

revoke references on table "public"."human_approval_workflows" from "service_role";

revoke select on table "public"."human_approval_workflows" from "service_role";

revoke trigger on table "public"."human_approval_workflows" from "service_role";

revoke truncate on table "public"."human_approval_workflows" from "service_role";

revoke update on table "public"."human_approval_workflows" from "service_role";

revoke delete on table "public"."learning_feedback_log" from "anon";

revoke insert on table "public"."learning_feedback_log" from "anon";

revoke references on table "public"."learning_feedback_log" from "anon";

revoke select on table "public"."learning_feedback_log" from "anon";

revoke trigger on table "public"."learning_feedback_log" from "anon";

revoke truncate on table "public"."learning_feedback_log" from "anon";

revoke update on table "public"."learning_feedback_log" from "anon";

revoke delete on table "public"."learning_feedback_log" from "authenticated";

revoke insert on table "public"."learning_feedback_log" from "authenticated";

revoke references on table "public"."learning_feedback_log" from "authenticated";

revoke select on table "public"."learning_feedback_log" from "authenticated";

revoke trigger on table "public"."learning_feedback_log" from "authenticated";

revoke truncate on table "public"."learning_feedback_log" from "authenticated";

revoke update on table "public"."learning_feedback_log" from "authenticated";

revoke delete on table "public"."learning_feedback_log" from "service_role";

revoke insert on table "public"."learning_feedback_log" from "service_role";

revoke references on table "public"."learning_feedback_log" from "service_role";

revoke select on table "public"."learning_feedback_log" from "service_role";

revoke trigger on table "public"."learning_feedback_log" from "service_role";

revoke truncate on table "public"."learning_feedback_log" from "service_role";

revoke update on table "public"."learning_feedback_log" from "service_role";

revoke delete on table "public"."learning_model_snapshots" from "anon";

revoke insert on table "public"."learning_model_snapshots" from "anon";

revoke references on table "public"."learning_model_snapshots" from "anon";

revoke select on table "public"."learning_model_snapshots" from "anon";

revoke trigger on table "public"."learning_model_snapshots" from "anon";

revoke truncate on table "public"."learning_model_snapshots" from "anon";

revoke update on table "public"."learning_model_snapshots" from "anon";

revoke delete on table "public"."learning_model_snapshots" from "authenticated";

revoke insert on table "public"."learning_model_snapshots" from "authenticated";

revoke references on table "public"."learning_model_snapshots" from "authenticated";

revoke select on table "public"."learning_model_snapshots" from "authenticated";

revoke trigger on table "public"."learning_model_snapshots" from "authenticated";

revoke truncate on table "public"."learning_model_snapshots" from "authenticated";

revoke update on table "public"."learning_model_snapshots" from "authenticated";

revoke delete on table "public"."learning_model_snapshots" from "service_role";

revoke insert on table "public"."learning_model_snapshots" from "service_role";

revoke references on table "public"."learning_model_snapshots" from "service_role";

revoke select on table "public"."learning_model_snapshots" from "service_role";

revoke trigger on table "public"."learning_model_snapshots" from "service_role";

revoke truncate on table "public"."learning_model_snapshots" from "service_role";

revoke update on table "public"."learning_model_snapshots" from "service_role";

revoke delete on table "public"."learning_rule_configurations" from "anon";

revoke insert on table "public"."learning_rule_configurations" from "anon";

revoke references on table "public"."learning_rule_configurations" from "anon";

revoke select on table "public"."learning_rule_configurations" from "anon";

revoke trigger on table "public"."learning_rule_configurations" from "anon";

revoke truncate on table "public"."learning_rule_configurations" from "anon";

revoke update on table "public"."learning_rule_configurations" from "anon";

revoke delete on table "public"."learning_rule_configurations" from "authenticated";

revoke insert on table "public"."learning_rule_configurations" from "authenticated";

revoke references on table "public"."learning_rule_configurations" from "authenticated";

revoke select on table "public"."learning_rule_configurations" from "authenticated";

revoke trigger on table "public"."learning_rule_configurations" from "authenticated";

revoke truncate on table "public"."learning_rule_configurations" from "authenticated";

revoke update on table "public"."learning_rule_configurations" from "authenticated";

revoke delete on table "public"."learning_rule_configurations" from "service_role";

revoke insert on table "public"."learning_rule_configurations" from "service_role";

revoke references on table "public"."learning_rule_configurations" from "service_role";

revoke select on table "public"."learning_rule_configurations" from "service_role";

revoke trigger on table "public"."learning_rule_configurations" from "service_role";

revoke truncate on table "public"."learning_rule_configurations" from "service_role";

revoke update on table "public"."learning_rule_configurations" from "service_role";

revoke delete on table "public"."maturity_levels" from "anon";

revoke insert on table "public"."maturity_levels" from "anon";

revoke references on table "public"."maturity_levels" from "anon";

revoke select on table "public"."maturity_levels" from "anon";

revoke trigger on table "public"."maturity_levels" from "anon";

revoke truncate on table "public"."maturity_levels" from "anon";

revoke update on table "public"."maturity_levels" from "anon";

revoke delete on table "public"."maturity_levels" from "authenticated";

revoke insert on table "public"."maturity_levels" from "authenticated";

revoke references on table "public"."maturity_levels" from "authenticated";

revoke select on table "public"."maturity_levels" from "authenticated";

revoke trigger on table "public"."maturity_levels" from "authenticated";

revoke truncate on table "public"."maturity_levels" from "authenticated";

revoke update on table "public"."maturity_levels" from "authenticated";

revoke delete on table "public"."maturity_levels" from "service_role";

revoke insert on table "public"."maturity_levels" from "service_role";

revoke references on table "public"."maturity_levels" from "service_role";

revoke select on table "public"."maturity_levels" from "service_role";

revoke trigger on table "public"."maturity_levels" from "service_role";

revoke truncate on table "public"."maturity_levels" from "service_role";

revoke update on table "public"."maturity_levels" from "service_role";

revoke delete on table "public"."maturity_practice_statements" from "anon";

revoke insert on table "public"."maturity_practice_statements" from "anon";

revoke references on table "public"."maturity_practice_statements" from "anon";

revoke select on table "public"."maturity_practice_statements" from "anon";

revoke trigger on table "public"."maturity_practice_statements" from "anon";

revoke truncate on table "public"."maturity_practice_statements" from "anon";

revoke update on table "public"."maturity_practice_statements" from "anon";

revoke delete on table "public"."maturity_practice_statements" from "authenticated";

revoke insert on table "public"."maturity_practice_statements" from "authenticated";

revoke references on table "public"."maturity_practice_statements" from "authenticated";

revoke select on table "public"."maturity_practice_statements" from "authenticated";

revoke trigger on table "public"."maturity_practice_statements" from "authenticated";

revoke truncate on table "public"."maturity_practice_statements" from "authenticated";

revoke update on table "public"."maturity_practice_statements" from "authenticated";

revoke delete on table "public"."maturity_practice_statements" from "service_role";

revoke insert on table "public"."maturity_practice_statements" from "service_role";

revoke references on table "public"."maturity_practice_statements" from "service_role";

revoke select on table "public"."maturity_practice_statements" from "service_role";

revoke trigger on table "public"."maturity_practice_statements" from "service_role";

revoke truncate on table "public"."maturity_practice_statements" from "service_role";

revoke update on table "public"."maturity_practice_statements" from "service_role";

revoke delete on table "public"."migration_status" from "anon";

revoke insert on table "public"."migration_status" from "anon";

revoke references on table "public"."migration_status" from "anon";

revoke select on table "public"."migration_status" from "anon";

revoke trigger on table "public"."migration_status" from "anon";

revoke truncate on table "public"."migration_status" from "anon";

revoke update on table "public"."migration_status" from "anon";

revoke delete on table "public"."migration_status" from "authenticated";

revoke insert on table "public"."migration_status" from "authenticated";

revoke references on table "public"."migration_status" from "authenticated";

revoke select on table "public"."migration_status" from "authenticated";

revoke trigger on table "public"."migration_status" from "authenticated";

revoke truncate on table "public"."migration_status" from "authenticated";

revoke update on table "public"."migration_status" from "authenticated";

revoke delete on table "public"."migration_status" from "service_role";

revoke insert on table "public"."migration_status" from "service_role";

revoke references on table "public"."migration_status" from "service_role";

revoke select on table "public"."migration_status" from "service_role";

revoke trigger on table "public"."migration_status" from "service_role";

revoke truncate on table "public"."migration_status" from "service_role";

revoke update on table "public"."migration_status" from "service_role";

revoke delete on table "public"."milestone_status_history" from "anon";

revoke insert on table "public"."milestone_status_history" from "anon";

revoke references on table "public"."milestone_status_history" from "anon";

revoke select on table "public"."milestone_status_history" from "anon";

revoke trigger on table "public"."milestone_status_history" from "anon";

revoke truncate on table "public"."milestone_status_history" from "anon";

revoke update on table "public"."milestone_status_history" from "anon";

revoke delete on table "public"."milestone_status_history" from "authenticated";

revoke insert on table "public"."milestone_status_history" from "authenticated";

revoke references on table "public"."milestone_status_history" from "authenticated";

revoke select on table "public"."milestone_status_history" from "authenticated";

revoke trigger on table "public"."milestone_status_history" from "authenticated";

revoke truncate on table "public"."milestone_status_history" from "authenticated";

revoke update on table "public"."milestone_status_history" from "authenticated";

revoke delete on table "public"."milestone_status_history" from "service_role";

revoke insert on table "public"."milestone_status_history" from "service_role";

revoke references on table "public"."milestone_status_history" from "service_role";

revoke select on table "public"."milestone_status_history" from "service_role";

revoke trigger on table "public"."milestone_status_history" from "service_role";

revoke truncate on table "public"."milestone_status_history" from "service_role";

revoke update on table "public"."milestone_status_history" from "service_role";

revoke delete on table "public"."milestone_tasks" from "anon";

revoke insert on table "public"."milestone_tasks" from "anon";

revoke references on table "public"."milestone_tasks" from "anon";

revoke select on table "public"."milestone_tasks" from "anon";

revoke trigger on table "public"."milestone_tasks" from "anon";

revoke truncate on table "public"."milestone_tasks" from "anon";

revoke update on table "public"."milestone_tasks" from "anon";

revoke delete on table "public"."milestone_tasks" from "authenticated";

revoke insert on table "public"."milestone_tasks" from "authenticated";

revoke references on table "public"."milestone_tasks" from "authenticated";

revoke select on table "public"."milestone_tasks" from "authenticated";

revoke trigger on table "public"."milestone_tasks" from "authenticated";

revoke truncate on table "public"."milestone_tasks" from "authenticated";

revoke update on table "public"."milestone_tasks" from "authenticated";

revoke delete on table "public"."milestone_tasks" from "service_role";

revoke insert on table "public"."milestone_tasks" from "service_role";

revoke references on table "public"."milestone_tasks" from "service_role";

revoke select on table "public"."milestone_tasks" from "service_role";

revoke trigger on table "public"."milestone_tasks" from "service_role";

revoke truncate on table "public"."milestone_tasks" from "service_role";

revoke update on table "public"."milestone_tasks" from "service_role";

revoke delete on table "public"."milestone_test_notes" from "anon";

revoke insert on table "public"."milestone_test_notes" from "anon";

revoke references on table "public"."milestone_test_notes" from "anon";

revoke select on table "public"."milestone_test_notes" from "anon";

revoke trigger on table "public"."milestone_test_notes" from "anon";

revoke truncate on table "public"."milestone_test_notes" from "anon";

revoke update on table "public"."milestone_test_notes" from "anon";

revoke delete on table "public"."milestone_test_notes" from "authenticated";

revoke insert on table "public"."milestone_test_notes" from "authenticated";

revoke references on table "public"."milestone_test_notes" from "authenticated";

revoke select on table "public"."milestone_test_notes" from "authenticated";

revoke trigger on table "public"."milestone_test_notes" from "authenticated";

revoke truncate on table "public"."milestone_test_notes" from "authenticated";

revoke update on table "public"."milestone_test_notes" from "authenticated";

revoke delete on table "public"."milestone_test_notes" from "service_role";

revoke insert on table "public"."milestone_test_notes" from "service_role";

revoke references on table "public"."milestone_test_notes" from "service_role";

revoke select on table "public"."milestone_test_notes" from "service_role";

revoke trigger on table "public"."milestone_test_notes" from "service_role";

revoke truncate on table "public"."milestone_test_notes" from "service_role";

revoke update on table "public"."milestone_test_notes" from "service_role";

revoke delete on table "public"."milestones" from "anon";

revoke insert on table "public"."milestones" from "anon";

revoke references on table "public"."milestones" from "anon";

revoke select on table "public"."milestones" from "anon";

revoke trigger on table "public"."milestones" from "anon";

revoke truncate on table "public"."milestones" from "anon";

revoke update on table "public"."milestones" from "anon";

revoke delete on table "public"."milestones" from "authenticated";

revoke insert on table "public"."milestones" from "authenticated";

revoke references on table "public"."milestones" from "authenticated";

revoke select on table "public"."milestones" from "authenticated";

revoke trigger on table "public"."milestones" from "authenticated";

revoke truncate on table "public"."milestones" from "authenticated";

revoke update on table "public"."milestones" from "authenticated";

revoke delete on table "public"."milestones" from "service_role";

revoke insert on table "public"."milestones" from "service_role";

revoke references on table "public"."milestones" from "service_role";

revoke select on table "public"."milestones" from "service_role";

revoke trigger on table "public"."milestones" from "service_role";

revoke truncate on table "public"."milestones" from "service_role";

revoke update on table "public"."milestones" from "service_role";

revoke delete on table "public"."org_crawl_queue" from "anon";

revoke insert on table "public"."org_crawl_queue" from "anon";

revoke references on table "public"."org_crawl_queue" from "anon";

revoke select on table "public"."org_crawl_queue" from "anon";

revoke trigger on table "public"."org_crawl_queue" from "anon";

revoke truncate on table "public"."org_crawl_queue" from "anon";

revoke update on table "public"."org_crawl_queue" from "anon";

revoke delete on table "public"."org_crawl_queue" from "authenticated";

revoke insert on table "public"."org_crawl_queue" from "authenticated";

revoke references on table "public"."org_crawl_queue" from "authenticated";

revoke select on table "public"."org_crawl_queue" from "authenticated";

revoke trigger on table "public"."org_crawl_queue" from "authenticated";

revoke truncate on table "public"."org_crawl_queue" from "authenticated";

revoke update on table "public"."org_crawl_queue" from "authenticated";

revoke delete on table "public"."org_crawl_queue" from "service_role";

revoke insert on table "public"."org_crawl_queue" from "service_role";

revoke references on table "public"."org_crawl_queue" from "service_role";

revoke select on table "public"."org_crawl_queue" from "service_role";

revoke trigger on table "public"."org_crawl_queue" from "service_role";

revoke truncate on table "public"."org_crawl_queue" from "service_role";

revoke update on table "public"."org_crawl_queue" from "service_role";

revoke delete on table "public"."org_domains" from "anon";

revoke insert on table "public"."org_domains" from "anon";

revoke references on table "public"."org_domains" from "anon";

revoke select on table "public"."org_domains" from "anon";

revoke trigger on table "public"."org_domains" from "anon";

revoke truncate on table "public"."org_domains" from "anon";

revoke update on table "public"."org_domains" from "anon";

revoke delete on table "public"."org_domains" from "authenticated";

revoke insert on table "public"."org_domains" from "authenticated";

revoke references on table "public"."org_domains" from "authenticated";

revoke select on table "public"."org_domains" from "authenticated";

revoke trigger on table "public"."org_domains" from "authenticated";

revoke truncate on table "public"."org_domains" from "authenticated";

revoke update on table "public"."org_domains" from "authenticated";

revoke delete on table "public"."org_domains" from "service_role";

revoke insert on table "public"."org_domains" from "service_role";

revoke references on table "public"."org_domains" from "service_role";

revoke select on table "public"."org_domains" from "service_role";

revoke trigger on table "public"."org_domains" from "service_role";

revoke truncate on table "public"."org_domains" from "service_role";

revoke update on table "public"."org_domains" from "service_role";

revoke delete on table "public"."org_ingest_jobs" from "anon";

revoke insert on table "public"."org_ingest_jobs" from "anon";

revoke references on table "public"."org_ingest_jobs" from "anon";

revoke select on table "public"."org_ingest_jobs" from "anon";

revoke trigger on table "public"."org_ingest_jobs" from "anon";

revoke truncate on table "public"."org_ingest_jobs" from "anon";

revoke update on table "public"."org_ingest_jobs" from "anon";

revoke delete on table "public"."org_ingest_jobs" from "authenticated";

revoke insert on table "public"."org_ingest_jobs" from "authenticated";

revoke references on table "public"."org_ingest_jobs" from "authenticated";

revoke select on table "public"."org_ingest_jobs" from "authenticated";

revoke trigger on table "public"."org_ingest_jobs" from "authenticated";

revoke truncate on table "public"."org_ingest_jobs" from "authenticated";

revoke update on table "public"."org_ingest_jobs" from "authenticated";

revoke delete on table "public"."org_ingest_jobs" from "service_role";

revoke insert on table "public"."org_ingest_jobs" from "service_role";

revoke references on table "public"."org_ingest_jobs" from "service_role";

revoke select on table "public"."org_ingest_jobs" from "service_role";

revoke trigger on table "public"."org_ingest_jobs" from "service_role";

revoke truncate on table "public"."org_ingest_jobs" from "service_role";

revoke update on table "public"."org_ingest_jobs" from "service_role";

revoke delete on table "public"."org_page_chunks" from "anon";

revoke insert on table "public"."org_page_chunks" from "anon";

revoke references on table "public"."org_page_chunks" from "anon";

revoke select on table "public"."org_page_chunks" from "anon";

revoke trigger on table "public"."org_page_chunks" from "anon";

revoke truncate on table "public"."org_page_chunks" from "anon";

revoke update on table "public"."org_page_chunks" from "anon";

revoke delete on table "public"."org_page_chunks" from "authenticated";

revoke insert on table "public"."org_page_chunks" from "authenticated";

revoke references on table "public"."org_page_chunks" from "authenticated";

revoke select on table "public"."org_page_chunks" from "authenticated";

revoke trigger on table "public"."org_page_chunks" from "authenticated";

revoke truncate on table "public"."org_page_chunks" from "authenticated";

revoke update on table "public"."org_page_chunks" from "authenticated";

revoke delete on table "public"."org_page_chunks" from "service_role";

revoke insert on table "public"."org_page_chunks" from "service_role";

revoke references on table "public"."org_page_chunks" from "service_role";

revoke select on table "public"."org_page_chunks" from "service_role";

revoke trigger on table "public"."org_page_chunks" from "service_role";

revoke truncate on table "public"."org_page_chunks" from "service_role";

revoke update on table "public"."org_page_chunks" from "service_role";

revoke delete on table "public"."org_pages" from "anon";

revoke insert on table "public"."org_pages" from "anon";

revoke references on table "public"."org_pages" from "anon";

revoke select on table "public"."org_pages" from "anon";

revoke trigger on table "public"."org_pages" from "anon";

revoke truncate on table "public"."org_pages" from "anon";

revoke update on table "public"."org_pages" from "anon";

revoke delete on table "public"."org_pages" from "authenticated";

revoke insert on table "public"."org_pages" from "authenticated";

revoke references on table "public"."org_pages" from "authenticated";

revoke select on table "public"."org_pages" from "authenticated";

revoke trigger on table "public"."org_pages" from "authenticated";

revoke truncate on table "public"."org_pages" from "authenticated";

revoke update on table "public"."org_pages" from "authenticated";

revoke delete on table "public"."org_pages" from "service_role";

revoke insert on table "public"."org_pages" from "service_role";

revoke references on table "public"."org_pages" from "service_role";

revoke select on table "public"."org_pages" from "service_role";

revoke trigger on table "public"."org_pages" from "service_role";

revoke truncate on table "public"."org_pages" from "service_role";

revoke update on table "public"."org_pages" from "service_role";

revoke delete on table "public"."org_profiles" from "anon";

revoke insert on table "public"."org_profiles" from "anon";

revoke references on table "public"."org_profiles" from "anon";

revoke select on table "public"."org_profiles" from "anon";

revoke trigger on table "public"."org_profiles" from "anon";

revoke truncate on table "public"."org_profiles" from "anon";

revoke update on table "public"."org_profiles" from "anon";

revoke delete on table "public"."org_profiles" from "authenticated";

revoke insert on table "public"."org_profiles" from "authenticated";

revoke references on table "public"."org_profiles" from "authenticated";

revoke select on table "public"."org_profiles" from "authenticated";

revoke trigger on table "public"."org_profiles" from "authenticated";

revoke truncate on table "public"."org_profiles" from "authenticated";

revoke update on table "public"."org_profiles" from "authenticated";

revoke delete on table "public"."org_profiles" from "service_role";

revoke insert on table "public"."org_profiles" from "service_role";

revoke references on table "public"."org_profiles" from "service_role";

revoke select on table "public"."org_profiles" from "service_role";

revoke trigger on table "public"."org_profiles" from "service_role";

revoke truncate on table "public"."org_profiles" from "service_role";

revoke update on table "public"."org_profiles" from "service_role";

revoke delete on table "public"."organization_documents" from "anon";

revoke insert on table "public"."organization_documents" from "anon";

revoke references on table "public"."organization_documents" from "anon";

revoke select on table "public"."organization_documents" from "anon";

revoke trigger on table "public"."organization_documents" from "anon";

revoke truncate on table "public"."organization_documents" from "anon";

revoke update on table "public"."organization_documents" from "anon";

revoke delete on table "public"."organization_documents" from "authenticated";

revoke insert on table "public"."organization_documents" from "authenticated";

revoke references on table "public"."organization_documents" from "authenticated";

revoke select on table "public"."organization_documents" from "authenticated";

revoke trigger on table "public"."organization_documents" from "authenticated";

revoke truncate on table "public"."organization_documents" from "authenticated";

revoke update on table "public"."organization_documents" from "authenticated";

revoke delete on table "public"."organization_documents" from "service_role";

revoke insert on table "public"."organization_documents" from "service_role";

revoke references on table "public"."organization_documents" from "service_role";

revoke select on table "public"."organization_documents" from "service_role";

revoke trigger on table "public"."organization_documents" from "service_role";

revoke truncate on table "public"."organization_documents" from "service_role";

revoke update on table "public"."organization_documents" from "service_role";

revoke delete on table "public"."organization_invitations" from "anon";

revoke insert on table "public"."organization_invitations" from "anon";

revoke references on table "public"."organization_invitations" from "anon";

revoke select on table "public"."organization_invitations" from "anon";

revoke trigger on table "public"."organization_invitations" from "anon";

revoke truncate on table "public"."organization_invitations" from "anon";

revoke update on table "public"."organization_invitations" from "anon";

revoke delete on table "public"."organization_invitations" from "authenticated";

revoke insert on table "public"."organization_invitations" from "authenticated";

revoke references on table "public"."organization_invitations" from "authenticated";

revoke select on table "public"."organization_invitations" from "authenticated";

revoke trigger on table "public"."organization_invitations" from "authenticated";

revoke truncate on table "public"."organization_invitations" from "authenticated";

revoke update on table "public"."organization_invitations" from "authenticated";

revoke delete on table "public"."organization_invitations" from "service_role";

revoke insert on table "public"."organization_invitations" from "service_role";

revoke references on table "public"."organization_invitations" from "service_role";

revoke select on table "public"."organization_invitations" from "service_role";

revoke trigger on table "public"."organization_invitations" from "service_role";

revoke truncate on table "public"."organization_invitations" from "service_role";

revoke update on table "public"."organization_invitations" from "service_role";

revoke delete on table "public"."organization_members" from "anon";

revoke insert on table "public"."organization_members" from "anon";

revoke references on table "public"."organization_members" from "anon";

revoke select on table "public"."organization_members" from "anon";

revoke trigger on table "public"."organization_members" from "anon";

revoke truncate on table "public"."organization_members" from "anon";

revoke update on table "public"."organization_members" from "anon";

revoke delete on table "public"."organization_members" from "authenticated";

revoke insert on table "public"."organization_members" from "authenticated";

revoke references on table "public"."organization_members" from "authenticated";

revoke select on table "public"."organization_members" from "authenticated";

revoke trigger on table "public"."organization_members" from "authenticated";

revoke truncate on table "public"."organization_members" from "authenticated";

revoke update on table "public"."organization_members" from "authenticated";

revoke delete on table "public"."organization_members" from "service_role";

revoke insert on table "public"."organization_members" from "service_role";

revoke references on table "public"."organization_members" from "service_role";

revoke select on table "public"."organization_members" from "service_role";

revoke trigger on table "public"."organization_members" from "service_role";

revoke truncate on table "public"."organization_members" from "service_role";

revoke update on table "public"."organization_members" from "service_role";

revoke delete on table "public"."organizations" from "anon";

revoke insert on table "public"."organizations" from "anon";

revoke references on table "public"."organizations" from "anon";

revoke select on table "public"."organizations" from "anon";

revoke trigger on table "public"."organizations" from "anon";

revoke truncate on table "public"."organizations" from "anon";

revoke update on table "public"."organizations" from "anon";

revoke delete on table "public"."organizations" from "authenticated";

revoke insert on table "public"."organizations" from "authenticated";

revoke references on table "public"."organizations" from "authenticated";

revoke select on table "public"."organizations" from "authenticated";

revoke trigger on table "public"."organizations" from "authenticated";

revoke truncate on table "public"."organizations" from "authenticated";

revoke update on table "public"."organizations" from "authenticated";

revoke delete on table "public"."organizations" from "service_role";

revoke insert on table "public"."organizations" from "service_role";

revoke references on table "public"."organizations" from "service_role";

revoke select on table "public"."organizations" from "service_role";

revoke trigger on table "public"."organizations" from "service_role";

revoke truncate on table "public"."organizations" from "service_role";

revoke update on table "public"."organizations" from "service_role";

revoke delete on table "public"."override_approvals" from "anon";

revoke insert on table "public"."override_approvals" from "anon";

revoke references on table "public"."override_approvals" from "anon";

revoke select on table "public"."override_approvals" from "anon";

revoke trigger on table "public"."override_approvals" from "anon";

revoke truncate on table "public"."override_approvals" from "anon";

revoke update on table "public"."override_approvals" from "anon";

revoke delete on table "public"."override_approvals" from "authenticated";

revoke insert on table "public"."override_approvals" from "authenticated";

revoke references on table "public"."override_approvals" from "authenticated";

revoke select on table "public"."override_approvals" from "authenticated";

revoke trigger on table "public"."override_approvals" from "authenticated";

revoke truncate on table "public"."override_approvals" from "authenticated";

revoke update on table "public"."override_approvals" from "authenticated";

revoke delete on table "public"."override_approvals" from "service_role";

revoke insert on table "public"."override_approvals" from "service_role";

revoke references on table "public"."override_approvals" from "service_role";

revoke select on table "public"."override_approvals" from "service_role";

revoke trigger on table "public"."override_approvals" from "service_role";

revoke truncate on table "public"."override_approvals" from "service_role";

revoke update on table "public"."override_approvals" from "service_role";

revoke delete on table "public"."pattern_recognition_history" from "anon";

revoke insert on table "public"."pattern_recognition_history" from "anon";

revoke references on table "public"."pattern_recognition_history" from "anon";

revoke select on table "public"."pattern_recognition_history" from "anon";

revoke trigger on table "public"."pattern_recognition_history" from "anon";

revoke truncate on table "public"."pattern_recognition_history" from "anon";

revoke update on table "public"."pattern_recognition_history" from "anon";

revoke delete on table "public"."pattern_recognition_history" from "authenticated";

revoke insert on table "public"."pattern_recognition_history" from "authenticated";

revoke references on table "public"."pattern_recognition_history" from "authenticated";

revoke select on table "public"."pattern_recognition_history" from "authenticated";

revoke trigger on table "public"."pattern_recognition_history" from "authenticated";

revoke truncate on table "public"."pattern_recognition_history" from "authenticated";

revoke update on table "public"."pattern_recognition_history" from "authenticated";

revoke delete on table "public"."pattern_recognition_history" from "service_role";

revoke insert on table "public"."pattern_recognition_history" from "service_role";

revoke references on table "public"."pattern_recognition_history" from "service_role";

revoke select on table "public"."pattern_recognition_history" from "service_role";

revoke trigger on table "public"."pattern_recognition_history" from "service_role";

revoke truncate on table "public"."pattern_recognition_history" from "service_role";

revoke update on table "public"."pattern_recognition_history" from "service_role";

revoke delete on table "public"."policy_change_log" from "anon";

revoke insert on table "public"."policy_change_log" from "anon";

revoke references on table "public"."policy_change_log" from "anon";

revoke select on table "public"."policy_change_log" from "anon";

revoke trigger on table "public"."policy_change_log" from "anon";

revoke truncate on table "public"."policy_change_log" from "anon";

revoke update on table "public"."policy_change_log" from "anon";

revoke delete on table "public"."policy_change_log" from "authenticated";

revoke insert on table "public"."policy_change_log" from "authenticated";

revoke references on table "public"."policy_change_log" from "authenticated";

revoke select on table "public"."policy_change_log" from "authenticated";

revoke trigger on table "public"."policy_change_log" from "authenticated";

revoke truncate on table "public"."policy_change_log" from "authenticated";

revoke update on table "public"."policy_change_log" from "authenticated";

revoke delete on table "public"."policy_change_log" from "service_role";

revoke insert on table "public"."policy_change_log" from "service_role";

revoke references on table "public"."policy_change_log" from "service_role";

revoke select on table "public"."policy_change_log" from "service_role";

revoke trigger on table "public"."policy_change_log" from "service_role";

revoke truncate on table "public"."policy_change_log" from "service_role";

revoke update on table "public"."policy_change_log" from "service_role";

revoke delete on table "public"."processing_pipeline_status" from "anon";

revoke insert on table "public"."processing_pipeline_status" from "anon";

revoke references on table "public"."processing_pipeline_status" from "anon";

revoke select on table "public"."processing_pipeline_status" from "anon";

revoke trigger on table "public"."processing_pipeline_status" from "anon";

revoke truncate on table "public"."processing_pipeline_status" from "anon";

revoke update on table "public"."processing_pipeline_status" from "anon";

revoke delete on table "public"."processing_pipeline_status" from "authenticated";

revoke insert on table "public"."processing_pipeline_status" from "authenticated";

revoke references on table "public"."processing_pipeline_status" from "authenticated";

revoke select on table "public"."processing_pipeline_status" from "authenticated";

revoke trigger on table "public"."processing_pipeline_status" from "authenticated";

revoke truncate on table "public"."processing_pipeline_status" from "authenticated";

revoke update on table "public"."processing_pipeline_status" from "authenticated";

revoke delete on table "public"."processing_pipeline_status" from "service_role";

revoke insert on table "public"."processing_pipeline_status" from "service_role";

revoke references on table "public"."processing_pipeline_status" from "service_role";

revoke select on table "public"."processing_pipeline_status" from "service_role";

revoke trigger on table "public"."processing_pipeline_status" from "service_role";

revoke truncate on table "public"."processing_pipeline_status" from "service_role";

revoke update on table "public"."processing_pipeline_status" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."qa_alerts" from "anon";

revoke insert on table "public"."qa_alerts" from "anon";

revoke references on table "public"."qa_alerts" from "anon";

revoke select on table "public"."qa_alerts" from "anon";

revoke trigger on table "public"."qa_alerts" from "anon";

revoke truncate on table "public"."qa_alerts" from "anon";

revoke update on table "public"."qa_alerts" from "anon";

revoke delete on table "public"."qa_alerts" from "authenticated";

revoke insert on table "public"."qa_alerts" from "authenticated";

revoke references on table "public"."qa_alerts" from "authenticated";

revoke select on table "public"."qa_alerts" from "authenticated";

revoke trigger on table "public"."qa_alerts" from "authenticated";

revoke truncate on table "public"."qa_alerts" from "authenticated";

revoke update on table "public"."qa_alerts" from "authenticated";

revoke delete on table "public"."qa_alerts" from "service_role";

revoke insert on table "public"."qa_alerts" from "service_role";

revoke references on table "public"."qa_alerts" from "service_role";

revoke select on table "public"."qa_alerts" from "service_role";

revoke trigger on table "public"."qa_alerts" from "service_role";

revoke truncate on table "public"."qa_alerts" from "service_role";

revoke update on table "public"."qa_alerts" from "service_role";

revoke delete on table "public"."qa_metrics" from "anon";

revoke insert on table "public"."qa_metrics" from "anon";

revoke references on table "public"."qa_metrics" from "anon";

revoke select on table "public"."qa_metrics" from "anon";

revoke trigger on table "public"."qa_metrics" from "anon";

revoke truncate on table "public"."qa_metrics" from "anon";

revoke update on table "public"."qa_metrics" from "anon";

revoke delete on table "public"."qa_metrics" from "authenticated";

revoke insert on table "public"."qa_metrics" from "authenticated";

revoke references on table "public"."qa_metrics" from "authenticated";

revoke select on table "public"."qa_metrics" from "authenticated";

revoke trigger on table "public"."qa_metrics" from "authenticated";

revoke truncate on table "public"."qa_metrics" from "authenticated";

revoke update on table "public"."qa_metrics" from "authenticated";

revoke delete on table "public"."qa_metrics" from "service_role";

revoke insert on table "public"."qa_metrics" from "service_role";

revoke references on table "public"."qa_metrics" from "service_role";

revoke select on table "public"."qa_metrics" from "service_role";

revoke trigger on table "public"."qa_metrics" from "service_role";

revoke truncate on table "public"."qa_metrics" from "service_role";

revoke update on table "public"."qa_metrics" from "service_role";

revoke delete on table "public"."qa_rules" from "anon";

revoke insert on table "public"."qa_rules" from "anon";

revoke references on table "public"."qa_rules" from "anon";

revoke select on table "public"."qa_rules" from "anon";

revoke trigger on table "public"."qa_rules" from "anon";

revoke truncate on table "public"."qa_rules" from "anon";

revoke update on table "public"."qa_rules" from "anon";

revoke delete on table "public"."qa_rules" from "authenticated";

revoke insert on table "public"."qa_rules" from "authenticated";

revoke references on table "public"."qa_rules" from "authenticated";

revoke select on table "public"."qa_rules" from "authenticated";

revoke trigger on table "public"."qa_rules" from "authenticated";

revoke truncate on table "public"."qa_rules" from "authenticated";

revoke update on table "public"."qa_rules" from "authenticated";

revoke delete on table "public"."qa_rules" from "service_role";

revoke insert on table "public"."qa_rules" from "service_role";

revoke references on table "public"."qa_rules" from "service_role";

revoke select on table "public"."qa_rules" from "service_role";

revoke trigger on table "public"."qa_rules" from "service_role";

revoke truncate on table "public"."qa_rules" from "service_role";

revoke update on table "public"."qa_rules" from "service_role";

revoke delete on table "public"."qa_test_log" from "anon";

revoke insert on table "public"."qa_test_log" from "anon";

revoke references on table "public"."qa_test_log" from "anon";

revoke select on table "public"."qa_test_log" from "anon";

revoke trigger on table "public"."qa_test_log" from "anon";

revoke truncate on table "public"."qa_test_log" from "anon";

revoke update on table "public"."qa_test_log" from "anon";

revoke delete on table "public"."qa_test_log" from "authenticated";

revoke insert on table "public"."qa_test_log" from "authenticated";

revoke references on table "public"."qa_test_log" from "authenticated";

revoke select on table "public"."qa_test_log" from "authenticated";

revoke trigger on table "public"."qa_test_log" from "authenticated";

revoke truncate on table "public"."qa_test_log" from "authenticated";

revoke update on table "public"."qa_test_log" from "authenticated";

revoke delete on table "public"."qa_test_log" from "service_role";

revoke insert on table "public"."qa_test_log" from "service_role";

revoke references on table "public"."qa_test_log" from "service_role";

revoke select on table "public"."qa_test_log" from "service_role";

revoke trigger on table "public"."qa_test_log" from "service_role";

revoke truncate on table "public"."qa_test_log" from "service_role";

revoke update on table "public"."qa_test_log" from "service_role";

revoke delete on table "public"."refactor_qa_log" from "anon";

revoke insert on table "public"."refactor_qa_log" from "anon";

revoke references on table "public"."refactor_qa_log" from "anon";

revoke select on table "public"."refactor_qa_log" from "anon";

revoke trigger on table "public"."refactor_qa_log" from "anon";

revoke truncate on table "public"."refactor_qa_log" from "anon";

revoke update on table "public"."refactor_qa_log" from "anon";

revoke delete on table "public"."refactor_qa_log" from "authenticated";

revoke insert on table "public"."refactor_qa_log" from "authenticated";

revoke references on table "public"."refactor_qa_log" from "authenticated";

revoke select on table "public"."refactor_qa_log" from "authenticated";

revoke trigger on table "public"."refactor_qa_log" from "authenticated";

revoke truncate on table "public"."refactor_qa_log" from "authenticated";

revoke update on table "public"."refactor_qa_log" from "authenticated";

revoke delete on table "public"."refactor_qa_log" from "service_role";

revoke insert on table "public"."refactor_qa_log" from "service_role";

revoke references on table "public"."refactor_qa_log" from "service_role";

revoke select on table "public"."refactor_qa_log" from "service_role";

revoke trigger on table "public"."refactor_qa_log" from "service_role";

revoke truncate on table "public"."refactor_qa_log" from "service_role";

revoke update on table "public"."refactor_qa_log" from "service_role";

revoke delete on table "public"."security_configuration" from "anon";

revoke insert on table "public"."security_configuration" from "anon";

revoke references on table "public"."security_configuration" from "anon";

revoke select on table "public"."security_configuration" from "anon";

revoke trigger on table "public"."security_configuration" from "anon";

revoke truncate on table "public"."security_configuration" from "anon";

revoke update on table "public"."security_configuration" from "anon";

revoke delete on table "public"."security_configuration" from "authenticated";

revoke insert on table "public"."security_configuration" from "authenticated";

revoke references on table "public"."security_configuration" from "authenticated";

revoke select on table "public"."security_configuration" from "authenticated";

revoke trigger on table "public"."security_configuration" from "authenticated";

revoke truncate on table "public"."security_configuration" from "authenticated";

revoke update on table "public"."security_configuration" from "authenticated";

revoke delete on table "public"."security_configuration" from "service_role";

revoke insert on table "public"."security_configuration" from "service_role";

revoke references on table "public"."security_configuration" from "service_role";

revoke select on table "public"."security_configuration" from "service_role";

revoke trigger on table "public"."security_configuration" from "service_role";

revoke truncate on table "public"."security_configuration" from "service_role";

revoke update on table "public"."security_configuration" from "service_role";

revoke delete on table "public"."security_exceptions" from "anon";

revoke insert on table "public"."security_exceptions" from "anon";

revoke references on table "public"."security_exceptions" from "anon";

revoke select on table "public"."security_exceptions" from "anon";

revoke trigger on table "public"."security_exceptions" from "anon";

revoke truncate on table "public"."security_exceptions" from "anon";

revoke update on table "public"."security_exceptions" from "anon";

revoke delete on table "public"."security_exceptions" from "authenticated";

revoke insert on table "public"."security_exceptions" from "authenticated";

revoke references on table "public"."security_exceptions" from "authenticated";

revoke select on table "public"."security_exceptions" from "authenticated";

revoke trigger on table "public"."security_exceptions" from "authenticated";

revoke truncate on table "public"."security_exceptions" from "authenticated";

revoke update on table "public"."security_exceptions" from "authenticated";

revoke delete on table "public"."security_exceptions" from "service_role";

revoke insert on table "public"."security_exceptions" from "service_role";

revoke references on table "public"."security_exceptions" from "service_role";

revoke select on table "public"."security_exceptions" from "service_role";

revoke trigger on table "public"."security_exceptions" from "service_role";

revoke truncate on table "public"."security_exceptions" from "service_role";

revoke update on table "public"."security_exceptions" from "service_role";

revoke delete on table "public"."security_monitoring" from "anon";

revoke insert on table "public"."security_monitoring" from "anon";

revoke references on table "public"."security_monitoring" from "anon";

revoke select on table "public"."security_monitoring" from "anon";

revoke trigger on table "public"."security_monitoring" from "anon";

revoke truncate on table "public"."security_monitoring" from "anon";

revoke update on table "public"."security_monitoring" from "anon";

revoke delete on table "public"."security_monitoring" from "authenticated";

revoke insert on table "public"."security_monitoring" from "authenticated";

revoke references on table "public"."security_monitoring" from "authenticated";

revoke select on table "public"."security_monitoring" from "authenticated";

revoke trigger on table "public"."security_monitoring" from "authenticated";

revoke truncate on table "public"."security_monitoring" from "authenticated";

revoke update on table "public"."security_monitoring" from "authenticated";

revoke delete on table "public"."security_monitoring" from "service_role";

revoke insert on table "public"."security_monitoring" from "service_role";

revoke references on table "public"."security_monitoring" from "service_role";

revoke select on table "public"."security_monitoring" from "service_role";

revoke trigger on table "public"."security_monitoring" from "service_role";

revoke truncate on table "public"."security_monitoring" from "service_role";

revoke update on table "public"."security_monitoring" from "service_role";

revoke delete on table "public"."security_rate_limits" from "anon";

revoke insert on table "public"."security_rate_limits" from "anon";

revoke references on table "public"."security_rate_limits" from "anon";

revoke select on table "public"."security_rate_limits" from "anon";

revoke trigger on table "public"."security_rate_limits" from "anon";

revoke truncate on table "public"."security_rate_limits" from "anon";

revoke update on table "public"."security_rate_limits" from "anon";

revoke delete on table "public"."security_rate_limits" from "authenticated";

revoke insert on table "public"."security_rate_limits" from "authenticated";

revoke references on table "public"."security_rate_limits" from "authenticated";

revoke select on table "public"."security_rate_limits" from "authenticated";

revoke trigger on table "public"."security_rate_limits" from "authenticated";

revoke truncate on table "public"."security_rate_limits" from "authenticated";

revoke update on table "public"."security_rate_limits" from "authenticated";

revoke delete on table "public"."security_rate_limits" from "service_role";

revoke insert on table "public"."security_rate_limits" from "service_role";

revoke references on table "public"."security_rate_limits" from "service_role";

revoke select on table "public"."security_rate_limits" from "service_role";

revoke trigger on table "public"."security_rate_limits" from "service_role";

revoke truncate on table "public"."security_rate_limits" from "service_role";

revoke update on table "public"."security_rate_limits" from "service_role";

revoke delete on table "public"."subscription_modules" from "anon";

revoke insert on table "public"."subscription_modules" from "anon";

revoke references on table "public"."subscription_modules" from "anon";

revoke select on table "public"."subscription_modules" from "anon";

revoke trigger on table "public"."subscription_modules" from "anon";

revoke truncate on table "public"."subscription_modules" from "anon";

revoke update on table "public"."subscription_modules" from "anon";

revoke delete on table "public"."subscription_modules" from "authenticated";

revoke insert on table "public"."subscription_modules" from "authenticated";

revoke references on table "public"."subscription_modules" from "authenticated";

revoke select on table "public"."subscription_modules" from "authenticated";

revoke trigger on table "public"."subscription_modules" from "authenticated";

revoke truncate on table "public"."subscription_modules" from "authenticated";

revoke update on table "public"."subscription_modules" from "authenticated";

revoke delete on table "public"."subscription_modules" from "service_role";

revoke insert on table "public"."subscription_modules" from "service_role";

revoke references on table "public"."subscription_modules" from "service_role";

revoke select on table "public"."subscription_modules" from "service_role";

revoke trigger on table "public"."subscription_modules" from "service_role";

revoke truncate on table "public"."subscription_modules" from "service_role";

revoke update on table "public"."subscription_modules" from "service_role";

revoke delete on table "public"."system_drift_detection" from "anon";

revoke insert on table "public"."system_drift_detection" from "anon";

revoke references on table "public"."system_drift_detection" from "anon";

revoke select on table "public"."system_drift_detection" from "anon";

revoke trigger on table "public"."system_drift_detection" from "anon";

revoke truncate on table "public"."system_drift_detection" from "anon";

revoke update on table "public"."system_drift_detection" from "anon";

revoke delete on table "public"."system_drift_detection" from "authenticated";

revoke insert on table "public"."system_drift_detection" from "authenticated";

revoke references on table "public"."system_drift_detection" from "authenticated";

revoke select on table "public"."system_drift_detection" from "authenticated";

revoke trigger on table "public"."system_drift_detection" from "authenticated";

revoke truncate on table "public"."system_drift_detection" from "authenticated";

revoke update on table "public"."system_drift_detection" from "authenticated";

revoke delete on table "public"."system_drift_detection" from "service_role";

revoke insert on table "public"."system_drift_detection" from "service_role";

revoke references on table "public"."system_drift_detection" from "service_role";

revoke select on table "public"."system_drift_detection" from "service_role";

revoke trigger on table "public"."system_drift_detection" from "service_role";

revoke truncate on table "public"."system_drift_detection" from "service_role";

revoke update on table "public"."system_drift_detection" from "service_role";

revoke delete on table "public"."system_reports" from "anon";

revoke insert on table "public"."system_reports" from "anon";

revoke references on table "public"."system_reports" from "anon";

revoke select on table "public"."system_reports" from "anon";

revoke trigger on table "public"."system_reports" from "anon";

revoke truncate on table "public"."system_reports" from "anon";

revoke update on table "public"."system_reports" from "anon";

revoke delete on table "public"."system_reports" from "authenticated";

revoke insert on table "public"."system_reports" from "authenticated";

revoke references on table "public"."system_reports" from "authenticated";

revoke select on table "public"."system_reports" from "authenticated";

revoke trigger on table "public"."system_reports" from "authenticated";

revoke truncate on table "public"."system_reports" from "authenticated";

revoke update on table "public"."system_reports" from "authenticated";

revoke delete on table "public"."system_reports" from "service_role";

revoke insert on table "public"."system_reports" from "service_role";

revoke references on table "public"."system_reports" from "service_role";

revoke select on table "public"."system_reports" from "service_role";

revoke trigger on table "public"."system_reports" from "service_role";

revoke truncate on table "public"."system_reports" from "service_role";

revoke update on table "public"."system_reports" from "service_role";

revoke delete on table "public"."upload_session_log" from "anon";

revoke insert on table "public"."upload_session_log" from "anon";

revoke references on table "public"."upload_session_log" from "anon";

revoke select on table "public"."upload_session_log" from "anon";

revoke trigger on table "public"."upload_session_log" from "anon";

revoke truncate on table "public"."upload_session_log" from "anon";

revoke update on table "public"."upload_session_log" from "anon";

revoke delete on table "public"."upload_session_log" from "authenticated";

revoke insert on table "public"."upload_session_log" from "authenticated";

revoke references on table "public"."upload_session_log" from "authenticated";

revoke select on table "public"."upload_session_log" from "authenticated";

revoke trigger on table "public"."upload_session_log" from "authenticated";

revoke truncate on table "public"."upload_session_log" from "authenticated";

revoke update on table "public"."upload_session_log" from "authenticated";

revoke delete on table "public"."upload_session_log" from "service_role";

revoke insert on table "public"."upload_session_log" from "service_role";

revoke references on table "public"."upload_session_log" from "service_role";

revoke select on table "public"."upload_session_log" from "service_role";

revoke trigger on table "public"."upload_session_log" from "service_role";

revoke truncate on table "public"."upload_session_log" from "service_role";

revoke update on table "public"."upload_session_log" from "service_role";

revoke delete on table "public"."watchdog_alerts" from "anon";

revoke insert on table "public"."watchdog_alerts" from "anon";

revoke references on table "public"."watchdog_alerts" from "anon";

revoke select on table "public"."watchdog_alerts" from "anon";

revoke trigger on table "public"."watchdog_alerts" from "anon";

revoke truncate on table "public"."watchdog_alerts" from "anon";

revoke update on table "public"."watchdog_alerts" from "anon";

revoke delete on table "public"."watchdog_alerts" from "authenticated";

revoke insert on table "public"."watchdog_alerts" from "authenticated";

revoke references on table "public"."watchdog_alerts" from "authenticated";

revoke select on table "public"."watchdog_alerts" from "authenticated";

revoke trigger on table "public"."watchdog_alerts" from "authenticated";

revoke truncate on table "public"."watchdog_alerts" from "authenticated";

revoke update on table "public"."watchdog_alerts" from "authenticated";

revoke delete on table "public"."watchdog_alerts" from "service_role";

revoke insert on table "public"."watchdog_alerts" from "service_role";

revoke references on table "public"."watchdog_alerts" from "service_role";

revoke select on table "public"."watchdog_alerts" from "service_role";

revoke trigger on table "public"."watchdog_alerts" from "service_role";

revoke truncate on table "public"."watchdog_alerts" from "service_role";

revoke update on table "public"."watchdog_alerts" from "service_role";

revoke delete on table "public"."watchdog_incidents" from "anon";

revoke insert on table "public"."watchdog_incidents" from "anon";

revoke references on table "public"."watchdog_incidents" from "anon";

revoke select on table "public"."watchdog_incidents" from "anon";

revoke trigger on table "public"."watchdog_incidents" from "anon";

revoke truncate on table "public"."watchdog_incidents" from "anon";

revoke update on table "public"."watchdog_incidents" from "anon";

revoke delete on table "public"."watchdog_incidents" from "authenticated";

revoke insert on table "public"."watchdog_incidents" from "authenticated";

revoke references on table "public"."watchdog_incidents" from "authenticated";

revoke select on table "public"."watchdog_incidents" from "authenticated";

revoke trigger on table "public"."watchdog_incidents" from "authenticated";

revoke truncate on table "public"."watchdog_incidents" from "authenticated";

revoke update on table "public"."watchdog_incidents" from "authenticated";

revoke delete on table "public"."watchdog_incidents" from "service_role";

revoke insert on table "public"."watchdog_incidents" from "service_role";

revoke references on table "public"."watchdog_incidents" from "service_role";

revoke select on table "public"."watchdog_incidents" from "service_role";

revoke trigger on table "public"."watchdog_incidents" from "service_role";

revoke truncate on table "public"."watchdog_incidents" from "service_role";

revoke update on table "public"."watchdog_incidents" from "service_role";

drop function if exists "public"."log_security_event"(event_type text, details jsonb);

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.accept_invitation(invitation_token_param uuid)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  invitation_record RECORD;
  user_email_var TEXT;
  new_member_id UUID;
BEGIN
  -- Get the current user's email from auth.users
  SELECT email INTO user_email_var 
  FROM auth.users 
  WHERE id = auth.uid();
  
  IF user_email_var IS NULL THEN
    RETURN json_build_object('success', false, 'error', 'User not authenticated');
  END IF;
  
  -- Find the invitation with organization details
  SELECT 
    oi.*,
    o.name as org_name,
    o.description as org_description
  INTO invitation_record 
  FROM public.organization_invitations oi
  JOIN public.organizations o ON oi.organization_id = o.id
  WHERE oi.invitation_token = invitation_token_param 
    AND oi.status = 'pending' 
    AND oi.expires_at > now()
    AND oi.email = user_email_var;
  
  IF NOT FOUND THEN
    IF EXISTS (
      SELECT 1 FROM public.organization_invitations 
      WHERE invitation_token = invitation_token_param 
        AND status = 'pending' 
        AND expires_at > now()
    ) THEN
      RETURN json_build_object('success', false, 'error', 'Invitation email does not match your account');
    END IF;
    
    RETURN json_build_object('success', false, 'error', 'Invalid or expired invitation');
  END IF;
  
  -- Check if user is already a member
  IF EXISTS (
    SELECT 1 FROM public.organization_members 
    WHERE organization_id = invitation_record.organization_id 
      AND user_id = auth.uid()
  ) THEN
    RETURN json_build_object('success', false, 'error', 'Already a member of this organization');
  END IF;
  
  -- Create the membership
  INSERT INTO public.organization_members (organization_id, user_id, role)
  VALUES (invitation_record.organization_id, auth.uid(), invitation_record.role)
  RETURNING id INTO new_member_id;
  
  -- Mark invitation as accepted
  UPDATE public.organization_invitations 
  SET status = 'accepted', updated_at = now()
  WHERE id = invitation_record.id;
  
  RETURN json_build_object(
    'success', true, 
    'member_id', new_member_id,
    'organization_id', invitation_record.organization_id,
    'organization_name', invitation_record.org_name,
    'organization_description', invitation_record.org_description,
    'role', invitation_record.role
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.add_backoffice_admin(admin_email text, admin_user_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  primary_org_id uuid;
BEGIN
  -- Only allow if current user is admin
  IF NOT is_user_admin() THEN
    RETURN FALSE;
  END IF;
  
  -- Get the user's primary organization
  SELECT get_user_primary_organization(admin_user_id) INTO primary_org_id;
  
  -- If no primary org, get any organization the user is a member of
  IF primary_org_id IS NULL THEN
    SELECT om.organization_id INTO primary_org_id
    FROM organization_members om
    WHERE om.user_id = admin_user_id
    LIMIT 1;
  END IF;
  
  -- Insert backoffice admin
  INSERT INTO public.backoffice_admins (user_id, email, granted_by)
  VALUES (admin_user_id, admin_email, auth.uid())
  ON CONFLICT (user_id) DO UPDATE SET
    email = EXCLUDED.email,
    granted_by = auth.uid(),
    granted_at = now();
  
  -- Ensure they have owner role in their organization (if they have one)
  IF primary_org_id IS NOT NULL THEN
    INSERT INTO public.organization_members (user_id, organization_id, role)
    VALUES (admin_user_id, primary_org_id, 'owner')
    ON CONFLICT (user_id, organization_id) DO UPDATE SET
      role = 'owner';
  END IF;
  
  -- Log the action
  INSERT INTO public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  ) VALUES (
    COALESCE(primary_org_id, '00000000-0000-0000-0000-000000000000'::uuid),
    'backoffice_admins',
    admin_user_id,
    'BACKOFFICE_ADMIN_ADDED',
    auth.uid(),
    'Added backoffice admin with upload permissions bypass'
  );
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.calculate_assessment_completion()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  total_criteria INTEGER;
  completed_criteria INTEGER;
  completion_pct DECIMAL(5,2);
BEGIN
  -- Count total criteria for this assessment
  SELECT COUNT(*) INTO total_criteria
  FROM public.criteria c
  JOIN public.maturity_practice_statements mps ON c.mps_id = mps.id
  JOIN public.domains d ON mps.domain_id = d.id
  WHERE d.organization_id = NEW.organization_id;
  
  -- Count completed criteria (approved status)
  SELECT COUNT(*) INTO completed_criteria
  FROM public.assessment_scores
  WHERE assessment_id = NEW.assessment_id 
    AND status = 'approved_locked';
  
  -- Calculate percentage
  IF total_criteria > 0 THEN
    completion_pct := (completed_criteria::DECIMAL / total_criteria::DECIMAL) * 100;
  ELSE
    completion_pct := 0;
  END IF;
  
  -- Update assessment completion percentage
  UPDATE public.assessments 
  SET overall_completion_percentage = completion_pct,
      updated_at = now()
  WHERE id = NEW.assessment_id;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.calculate_assessment_progress(assessment_uuid uuid)
 RETURNS TABLE(total_criteria integer, completed_criteria integer, completion_percentage numeric)
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*)::INTEGER as total_criteria,
    COUNT(CASE WHEN ase.status = 'approved_locked' THEN 1 END)::INTEGER as completed_criteria,
    CASE 
      WHEN COUNT(*) > 0 THEN 
        ROUND((COUNT(CASE WHEN ase.status = 'approved_locked' THEN 1 END)::NUMERIC / COUNT(*)::NUMERIC) * 100, 2)
      ELSE 0::NUMERIC(5,2)
    END as completion_percentage
  FROM public.assessment_scores ase
  WHERE ase.assessment_id = assessment_uuid;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.can_manage_document(doc_org_id uuid, doc_context_level text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Superuser bypass - can manage any document
  IF is_superuser() THEN
    RETURN TRUE;
  END IF;
  
  -- Global documents can be managed by backoffice admins
  IF doc_context_level = 'global' AND EXISTS (
    SELECT 1 FROM backoffice_admins WHERE user_id = auth.uid()
  ) THEN
    RETURN TRUE;
  END IF;
  
  -- Organization-specific document access
  RETURN EXISTS (
    SELECT 1 FROM organization_members om
    WHERE om.organization_id = doc_org_id 
      AND om.user_id = auth.uid() 
      AND om.role IN ('admin', 'owner')
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.chat_search_contains(p_org_id uuid, p_phrase text, p_top_k integer DEFAULT 8)
 RETURNS TABLE(doc_id uuid, title text, snippet text)
 LANGUAGE sql
 STABLE
AS $function$
SELECT
  d.id        AS doc_id,
  d.title,
  LEFT(c.content, 300) AS snippet
FROM public.ai_document_chunks c
JOIN public.v_ai_docs_retrievable d ON d.id = c.document_id
WHERE d.organization_id = p_org_id
  AND c.content ILIKE '%' || p_phrase || '%'
ORDER BY d.updated_at DESC
LIMIT p_top_k;
$function$
;

CREATE OR REPLACE FUNCTION public.check_rate_limit(operation_type_param text, max_attempts integer DEFAULT 5, window_minutes integer DEFAULT 60)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  current_count integer;
  window_start_time timestamp with time zone;
BEGIN
  window_start_time := now() - (window_minutes || ' minutes')::interval;
  
  -- Clean old rate limit records
  DELETE FROM public.security_rate_limits 
  WHERE window_start < window_start_time;
  
  -- Get current attempt count
  SELECT attempt_count INTO current_count
  FROM public.security_rate_limits
  WHERE user_id = auth.uid() 
    AND operation_type = operation_type_param
    AND window_start >= window_start_time;
  
  IF current_count IS NULL THEN
    -- First attempt in window
    INSERT INTO public.security_rate_limits (user_id, operation_type, attempt_count)
    VALUES (auth.uid(), operation_type_param, 1)
    ON CONFLICT (user_id, operation_type) 
    DO UPDATE SET 
      attempt_count = 1,
      window_start = now();
    
    RETURN true;
  ELSIF current_count >= max_attempts THEN
    -- Rate limit exceeded
    INSERT INTO public.audit_trail (
      organization_id, table_name, record_id, action, changed_by, change_reason
    ) VALUES (
      '00000000-0000-0000-0000-000000000000'::uuid,
      'rate_limits',
      auth.uid(),
      'RATE_LIMIT_EXCEEDED',
      auth.uid(),
      'Rate limit exceeded for operation: ' || operation_type_param
    );
    
    RETURN false;
  ELSE
    -- Increment counter
    UPDATE public.security_rate_limits 
    SET attempt_count = attempt_count + 1
    WHERE user_id = auth.uid() AND operation_type = operation_type_param;
    
    RETURN true;
  END IF;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_rate_limit(user_id_param uuid, action_type_param text, window_minutes_param integer DEFAULT 5, max_attempts_param integer DEFAULT 10)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  attempt_count integer;
BEGIN
  -- Count recent attempts within the time window
  SELECT COUNT(*) INTO attempt_count
  FROM rate_limit_log
  WHERE user_id = user_id_param
    AND action_type = action_type_param
    AND attempted_at > (now() - (window_minutes_param || ' minutes')::interval);
  
  -- Log this attempt
  INSERT INTO rate_limit_log (user_id, action_type, attempted_at)
  VALUES (user_id_param, action_type_param, now());
  
  -- Return true if under the limit, false if over
  RETURN attempt_count < max_attempts_param;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_rate_limit(user_identifier text, operation_type text, max_requests integer DEFAULT 10, time_window_seconds integer DEFAULT 60)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  request_count integer;
  window_start timestamp with time zone;
BEGIN
  window_start := now() - (time_window_seconds || ' seconds')::interval;
  
  -- Count recent requests
  SELECT COUNT(*) INTO request_count
  FROM public.audit_trail
  WHERE changed_by = auth.uid()
    AND action = operation_type
    AND changed_at > window_start;
  
  -- If limit exceeded, log and return false
  IF request_count >= max_requests THEN
    INSERT INTO public.audit_trail (
      organization_id,
      table_name,
      record_id,
      action,
      changed_by,
      change_reason
    ) VALUES (
      '00000000-0000-0000-0000-000000000000'::uuid,
      'rate_limiting',
      auth.uid(),
      'RATE_LIMIT_EXCEEDED',
      auth.uid(),
      'Rate limit exceeded for operation: ' || operation_type || ' (' || request_count || '/' || max_requests || ')'
    );
    
    RETURN FALSE;
  END IF;
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.chunk_quality_score(p_text text)
 RETURNS real
 LANGUAGE sql
 IMMUTABLE
AS $function$
  WITH t AS (
    SELECT
      COALESCE(length(p_text), 0) AS total_len,
      length(
        regexp_replace(
          p_text,
          E'[^A-Za-z0-9\\s\\.,;:\\\'\"()/%-]+',  -- remove chars NOT in this set
          '',
          'g'
        )
      ) AS kept_len,
      length(regexp_replace(p_text, '[^0-9]', '', 'g')) AS digits_len
  )
  SELECT CASE
           WHEN total_len = 0 THEN 0
           ELSE kept_len::real / NULLIF(total_len, 0)
         END
  FROM t;
$function$
;

CREATE OR REPLACE FUNCTION public.coerce_ai_docs_tags_to_array()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_text text;
BEGIN
  -- If NULL, leave it
  IF NEW.tags IS NULL THEN
    RETURN NEW;
  END IF;

  -- If tags is already an array, trim empties and return
  BEGIN
    NEW.tags := (
      SELECT NULLIF(ARRAY(
        SELECT DISTINCT NULLIF(trim(x), '')
        FROM unnest(NEW.tags) AS x
      ), ARRAY[]::text[])
    );
    RETURN NEW;
  EXCEPTION WHEN array_subscript_error OR datatype_mismatch THEN
    -- fall through if NEW.tags isn't an array type
  END;

  -- Otherwise, treat it as TEXT and coerce
  v_text := NEW.tags::text;

  NEW.tags := NULLIF(
    ARRAY(
      SELECT DISTINCT NULLIF(trim(x), '')
      FROM unnest(
        CASE
          WHEN v_text IS NULL OR v_text = '' THEN ARRAY[]::text[]
          WHEN v_text ~ '^\{.*\}$'             THEN v_text::text[]                      -- postgres array literal
          WHEN v_text ~ '^\[.*\]$'             THEN regexp_split_to_array(              -- json-like list
                                            replace(trim(both '[]' from v_text), '"',''),
                                            '\s*,\s*')
          ELSE                                       regexp_split_to_array(v_text, '\s*[;,]\s*')
        END
      ) AS x
    ),
    ARRAY[]::text[]
  );

  RETURN NEW;
END
$function$
;

CREATE OR REPLACE FUNCTION public.count_chunks_by_organization(org_id_param uuid)
 RETURNS TABLE(total_chunks bigint, chunks_with_embeddings bigint)
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*) as total_chunks,
    COUNT(CASE WHEN embedding IS NOT NULL THEN 1 END) as chunks_with_embeddings
  FROM ai_document_chunks adc
  JOIN ai_documents ad ON adc.document_id = ad.id
  WHERE ad.organization_id = org_id_param;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_document_version()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  max_version INTEGER;
BEGIN
  -- Only create version if this is an update (not insert)
  IF TG_OP = 'UPDATE' THEN
    -- Get the current max version for this document
    SELECT COALESCE(MAX(version_number), 0) INTO max_version
    FROM public.ai_document_versions 
    WHERE document_id = OLD.id;
    
    -- Create new version record with previous data
    INSERT INTO public.ai_document_versions (
      document_id,
      version_number,
      title,
      domain,
      tags,
      upload_notes,
      document_type,
      metadata,
      file_path,
      file_name,
      file_size,
      mime_type,
      created_by,
      organization_id,
      change_reason
    ) VALUES (
      OLD.id,
      max_version + 1,
      OLD.title,
      OLD.domain,
      OLD.tags,
      OLD.upload_notes,
      OLD.document_type,
      OLD.metadata,
      OLD.file_path,
      OLD.file_name,
      OLD.file_size,
      OLD.mime_type,
      NEW.updated_by,
      OLD.organization_id,
      COALESCE(NEW.metadata->>'change_reason', 'Document updated')
    );
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.default_org_profile_metadata()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF (NEW.file_name ILIKE 'Organization_Profile_%'
      OR NEW.title ILIKE 'Organization_Profile_%'
      OR NEW.file_name ILIKE '%Company_Overview%'
      OR NEW.title ILIKE '%Company_Overview%') THEN

    NEW.doc_type := COALESCE(NEW.doc_type, 'organization_profile');
    NEW.layer    := COALESCE(NEW.layer, 1);
    NEW.domain   := COALESCE(NEW.domain, 'Leadership & Governance');

    IF NEW.tags IS NULL OR array_length(NEW.tags,1) IS NULL THEN
      NEW.tags := ARRAY['organization-profile','leadership-and-governance','company-overview'];
    END IF;
  END IF;

  RETURN NEW;
END$function$
;

CREATE OR REPLACE FUNCTION public.enforce_org_doc_path()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
begin
  if new.source_object_path !~ '^org/[0-9a-fA-F-]+/inbox/' then
    raise exception 'Invalid document path: %', new.source_object_path;
  end if;
  return new;
end $function$
;

CREATE OR REPLACE FUNCTION public.enhanced_input_validation(input_data jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  validation_result jsonb;
  security_score numeric := 1.0;
  risk_factors text[] := ARRAY[]::text[];
BEGIN
  -- Initialize validation result
  validation_result := jsonb_build_object(
    'is_valid', true,
    'security_score', security_score,
    'risk_factors', risk_factors,
    'sanitized_input', input_data
  );
  
  -- Basic SQL injection detection
  IF input_data::text ~* '(DROP|DELETE|TRUNCATE|ALTER|CREATE|INSERT|UPDATE|GRANT|REVOKE)\s' THEN
    risk_factors := array_append(risk_factors, 'sql_injection_keywords');
    security_score := security_score * 0.1;
  END IF;
  
  -- XSS detection
  IF input_data::text ~* '(<script|javascript:|on\w+\s*=|eval\s*\(|expression\s*\()' THEN
    risk_factors := array_append(risk_factors, 'xss_patterns');
    security_score := security_score * 0.2;
  END IF;
  
  -- Check for suspicious patterns
  IF input_data::text ~* '(union\s+select|or\s+1\s*=\s*1|and\s+1\s*=\s*1)' THEN
    risk_factors := array_append(risk_factors, 'sql_union_injection');
    security_score := security_score * 0.1;
  END IF;
  
  -- Update result
  validation_result := jsonb_build_object(
    'is_valid', security_score > 0.5,
    'security_score', security_score,
    'risk_factors', risk_factors,
    'sanitized_input', input_data
  );
  
  -- Log security violations
  IF security_score < 0.5 THEN
    INSERT INTO audit_trail (
      organization_id,
      table_name,
      record_id,
      action,
      changed_by,
      change_reason
    ) VALUES (
      '00000000-0000-0000-0000-000000000000'::uuid,
      'security_validation',
      auth.uid(),
      'SECURITY_VIOLATION_DETECTED',
      auth.uid(),
      'Enhanced validation failed: ' || array_to_string(risk_factors, ', ')
    );
  END IF;
  
  RETURN validation_result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.enhanced_input_validation(input_text text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  security_patterns text[] := ARRAY[
    -- SQL injection patterns
    'DROP\s+TABLE',
    'DELETE\s+FROM',
    'TRUNCATE\s+TABLE',
    'ALTER\s+TABLE',
    'CREATE\s+TABLE',
    'INSERT\s+INTO.*admin_users',
    'UPDATE.*admin_users',
    'GRANT\s+',
    'REVOKE\s+',
    -- XSS patterns
    '<script[^>]*>',
    'javascript:',
    'on\w+\s*=',
    'eval\s*\(',
    'expression\s*\(',
    'document\.cookie',
    'window\.location',
    -- Additional security patterns
    'union\s+select',
    'sleep\s*\(',
    'waitfor\s+delay',
    'benchmark\s*\(',
    'pg_sleep\s*\('
  ];
  pattern text;
  violations text[] := '{}';
BEGIN
  -- Check for malicious patterns
  FOREACH pattern IN ARRAY security_patterns
  LOOP
    IF input_text ~* pattern THEN
      violations := array_append(violations, pattern);
    END IF;
  END LOOP;
  
  -- If violations found, log and return invalid
  IF array_length(violations, 1) > 0 THEN
    INSERT INTO public.audit_trail (
      organization_id,
      table_name,
      record_id,
      action,
      changed_by,
      change_reason
    ) VALUES (
      '00000000-0000-0000-0000-000000000000'::uuid,
      'security_validation',
      auth.uid(),
      'SECURITY_VIOLATION_DETECTED',
      auth.uid(),
      'Malicious patterns detected: ' || array_to_string(violations, ', ')
    );
    
    RETURN jsonb_build_object(
      'valid', false,
      'errors', violations,
      'sanitized', '',
      'message', 'Input contains potentially malicious content'
    );
  END IF;
  
  -- Basic sanitization
  RETURN jsonb_build_object(
    'valid', true,
    'errors', '{}',
    'sanitized', trim(input_text),
    'message', 'Input validation passed'
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.expire_approval_requests()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Mark expired approval requests as expired and log the action
  UPDATE approval_requests 
  SET 
    decision = 'expired',
    decided_at = now(),
    updated_at = now()
  WHERE decision = 'pending' 
    AND expires_at < now();
    
  -- Log the expiration action
  INSERT INTO audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  )
  SELECT 
    organization_id,
    'approval_requests',
    id,
    'auto_expired',
    '00000000-0000-0000-0000-000000000001'::uuid,
    'Approval request expired automatically'
  FROM approval_requests 
  WHERE decision = 'expired' 
    AND decided_at >= now() - interval '1 minute';
END;
$function$
;

CREATE OR REPLACE FUNCTION public.fill_tokens_estimate()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.tokens IS NULL AND NEW.content IS NOT NULL THEN
    NEW.tokens := CEIL(LENGTH(NEW.content)::numeric / 4.0)::int;
  END IF;
  RETURN NEW;
END$function$
;

CREATE OR REPLACE FUNCTION public.generate_criteria_number()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  mps_num INTEGER;
  next_criteria_num INTEGER;
BEGIN
  -- Get the MPS number
  SELECT mps_number INTO mps_num 
  FROM public.maturity_practice_statements 
  WHERE id = NEW.mps_id;
  
  -- Get the next criteria number for this MPS
  SELECT COALESCE(MAX(CAST(SPLIT_PART(criteria_number, '.', 2) AS INTEGER)), 0) + 1
  INTO next_criteria_num
  FROM public.criteria c
  JOIN public.maturity_practice_statements mps ON c.mps_id = mps.id
  WHERE mps.id = NEW.mps_id;
  
  -- Set the criteria number
  NEW.criteria_number := mps_num || '.' || next_criteria_num;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_completed_documents()
 RETURNS TABLE(id uuid, organization_id uuid, file_name text, title text, doc_type text, domain text, tags text[], total_chunks integer, updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Check if user has access to view documents
  IF NOT EXISTS (
    SELECT 1 FROM organization_members 
    WHERE user_id = auth.uid()
  ) THEN
    RAISE EXCEPTION 'Must be a member of an organization to view documents';
  END IF;
  
  RETURN QUERY
  SELECT 
    d.id,
    d.organization_id,
    d.file_name,
    COALESCE(d.title, regexp_replace(d.file_name, '\.[^.]+$', '', 'g')) AS title,
    d.document_type AS doc_type,
    d.domain,
    d.tags,
    d.total_chunks,
    d.updated_at
  FROM ai_documents d
  JOIN organization_members om ON d.organization_id = om.organization_id
  WHERE om.user_id = auth.uid()
    AND d.processing_status = 'completed'
    AND d.total_chunks > 0;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_demo_documents()
 RETURNS TABLE(id uuid, file_name text, title text, document_type text, domain text, tags text[], total_chunks integer, created_at timestamp with time zone, processing_status text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Only allow if user has appropriate permissions
  IF NOT EXISTS (
    SELECT 1 FROM organization_members 
    WHERE user_id = auth.uid() 
      AND role IN ('admin', 'owner')
  ) THEN
    RAISE EXCEPTION 'Insufficient permissions to access demo documents';
  END IF;
  
  RETURN QUERY
  SELECT 
    d.id,
    d.file_name,
    COALESCE(d.title, regexp_replace(d.file_name, '\.[^.]+$', '', 'g')) as title,
    d.document_type,
    d.domain,
    d.tags,
    d.total_chunks,
    d.created_at,
    d.processing_status
  FROM ai_documents d
  WHERE (d.metadata->>'demo_accessible')::boolean = true
    AND d.processing_status = 'completed'
    AND d.total_chunks > 0;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_filtered_document_chunks(exclude_boilerplate boolean DEFAULT true)
 RETURNS TABLE(id uuid, document_id uuid, organization_id uuid, chunk_index integer, content text, content_hash text, embedding vector, metadata jsonb, created_at timestamp with time zone, tokens integer, page integer, section text, equipment_slugs text[], stage text, layer smallint, tags text[], status text, visibility text, uploaded_by uuid, uploaded_at timestamp with time zone, updated_at timestamp with time zone, checksum text, quality_score real, is_clean boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Check if user has access to view chunks
  IF NOT EXISTS (
    SELECT 1 FROM organization_members 
    WHERE user_id = auth.uid()
  ) THEN
    RAISE EXCEPTION 'Must be a member of an organization to view document chunks';
  END IF;
  
  RETURN QUERY
  SELECT 
    c.id,
    c.document_id,
    c.organization_id,
    c.chunk_index,
    c.content,
    c.content_hash,
    c.embedding,
    c.metadata,
    c.created_at,
    c.tokens,
    c.page,
    c.section,
    c.equipment_slugs,
    c.stage,
    c.layer,
    c.tags,
    c.status,
    c.visibility,
    c.uploaded_by,
    c.uploaded_at,
    c.updated_at,
    c.checksum,
    c.quality_score,
    c.is_clean
  FROM ai_document_chunks c
  JOIN organization_members om ON c.organization_id = om.organization_id
  WHERE om.user_id = auth.uid()
    AND (NOT exclude_boilerplate OR COALESCE((c.metadata->>'boilerplate')::text, 'false') <> 'true');
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_organization_hierarchy(org_id uuid)
 RETURNS TABLE(id uuid, name text, organization_level text, parent_organization_id uuid, depth integer)
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
    WITH RECURSIVE org_hierarchy AS (
        -- Base case: start with the given organization
        SELECT 
            o.id,
            o.name,
            o.organization_level,
            o.parent_organization_id,
            0 as depth
        FROM organizations o
        WHERE o.id = org_id
        
        UNION ALL
        
        -- Recursive case: get children
        SELECT 
            o.id,
            o.name,
            o.organization_level,
            o.parent_organization_id,
            oh.depth + 1
        FROM organizations o
        INNER JOIN org_hierarchy oh ON o.parent_organization_id = oh.id
        WHERE oh.depth < 5 -- Prevent infinite recursion
    )
    SELECT * FROM org_hierarchy ORDER BY depth, name;
$function$
;

CREATE OR REPLACE FUNCTION public.get_security_setting(setting_name_param text)
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  result jsonb;
BEGIN
  SELECT setting_value INTO result
  FROM public.security_configuration
  WHERE setting_name = setting_name_param;
  
  RETURN COALESCE(result, 'null'::jsonb);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_organization_context(target_user_id uuid DEFAULT auth.uid())
 RETURNS TABLE(organization_id uuid, user_role text, organization_type text, can_upload boolean)
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Return organization context for the user with upload permissions
  RETURN QUERY
  SELECT 
    o.id as organization_id,
    om.role as user_role,
    o.organization_type,
    (om.role IN ('admin', 'owner')) as can_upload
  FROM organizations o
  JOIN organization_members om ON o.id = om.organization_id
  WHERE om.user_id = target_user_id
  ORDER BY 
    -- Prioritize primary organizations, then by role hierarchy
    CASE o.organization_type WHEN 'primary' THEN 1 ELSE 2 END,
    CASE om.role 
      WHEN 'owner' THEN 1 
      WHEN 'admin' THEN 2 
      WHEN 'assessor' THEN 3 
      ELSE 4 
    END;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_primary_organization(user_uuid uuid DEFAULT auth.uid())
 RETURNS uuid
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
  SELECT o.id
  FROM public.organizations o
  LEFT JOIN public.organization_members om ON om.organization_id = o.id
  WHERE (o.owner_id = user_uuid OR om.user_id = user_uuid)
    AND o.organization_type = 'primary'
  LIMIT 1;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_organization()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  INSERT INTO public.organization_members (organization_id, user_id, role)
  VALUES (NEW.id, NEW.owner_id, 'owner');
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  INSERT INTO public.profiles (user_id, full_name, email)
  VALUES (
    NEW.id,
    NEW.raw_user_meta_data ->> 'full_name',
    NEW.email
  );
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.has_org_role(org_id_param uuid, allowed_roles_param text[])
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  select exists (
    select 1
    from public.organization_members m
    where m.organization_id = org_id_param
      and m.user_id = auth.uid()
      and m.role = any(allowed_roles_param)
  );
$function$
;

CREATE OR REPLACE FUNCTION public.is_chunk_clean(p_text text)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE
AS $function$
WITH chars AS (
  SELECT
    length(p_text)                                   AS total,
    length(regexp_replace(p_text, '[A-Za-z]', '', 'g')) AS non_letters,
    length(regexp_replace(p_text, '[\x20-\x7E\n\r\t]', '', 'g')) AS non_printables
),
toks AS (
  SELECT cardinality(regexp_split_to_array(coalesce(p_text,''), '\s+')) AS tokens
)
SELECT
  CASE
    WHEN p_text IS NULL OR length(p_text) = 0 THEN FALSE
    WHEN (SELECT total FROM chars) < 40 THEN FALSE                                   -- too short to be useful
    WHEN (SELECT non_printables::float / NULLIF(total,0) FROM chars) > 0.08 THEN FALSE
    WHEN (SELECT tokens FROM toks) < 5 THEN FALSE                                   -- too few tokens
    ELSE TRUE
  END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_org_member(org_id_param uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  select exists (
    select 1
    from public.organization_members m
    where m.organization_id = org_id_param
      and m.user_id = auth.uid()
  );
$function$
;

CREATE OR REPLACE FUNCTION public.is_primary_organization(org_uuid uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
  SELECT EXISTS (
    SELECT 1 FROM public.organizations 
    WHERE id = org_uuid AND organization_type = 'primary'
  );
$function$
;

CREATE OR REPLACE FUNCTION public.is_superuser(user_id_param uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT EXISTS (
    SELECT 1 FROM public.backoffice_admins ba
    WHERE ba.user_id = user_id_param
  ) OR EXISTS (
    SELECT 1 FROM public.admin_users au
    WHERE au.user_id = user_id_param
  );
$function$
;

CREATE OR REPLACE FUNCTION public.is_user_admin(user_uuid uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
  SELECT EXISTS (
    SELECT 1 FROM public.admin_users 
    WHERE user_id = user_uuid
  );
$function$
;

CREATE OR REPLACE FUNCTION public.list_public_tables()
 RETURNS TABLE(table_name text)
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT table_name::text
  FROM information_schema.tables
  WHERE table_schema = 'public'
  ORDER BY table_name;
$function$
;

CREATE OR REPLACE FUNCTION public.log_admin_activity()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  INSERT INTO public.admin_activity_log (
    admin_user_id,
    action_type,
    entity_type,
    entity_id,
    details
  ) VALUES (
    auth.uid(),
    TG_OP,
    TG_TABLE_NAME,
    COALESCE(NEW.id, OLD.id),
    CASE 
      WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD)
      ELSE to_jsonb(NEW)
    END
  );
  
  RETURN COALESCE(NEW, OLD);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_admin_security_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  -- Only log if we have a valid auth.uid()
  IF auth.uid() IS NOT NULL THEN
    INSERT INTO public.admin_activity_log (
      admin_user_id,
      action_type,
      entity_type,
      entity_id,
      details,
      ip_address
    ) VALUES (
      auth.uid(),
      TG_OP || '_SECURITY_CHECK',
      TG_TABLE_NAME,
      COALESCE(NEW.id, OLD.id),
      jsonb_build_object(
        'operation', TG_OP,
        'table', TG_TABLE_NAME,
        'timestamp', now(),
        'user_id', auth.uid(),
        'validation_passed', public.user_has_role(auth.uid(), 'admin')
      ),
      inet_client_addr()
    );
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_assessment_audit_trail()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Insert audit record for UPDATE operations on assessment-related tables
  IF TG_OP = 'UPDATE' THEN
    -- Log each changed field with specific focus on status changes
    INSERT INTO public.audit_trail (
      organization_id, table_name, record_id, action, field_name, 
      old_value, new_value, changed_by, change_reason
    )
    SELECT 
      COALESCE(NEW.organization_id, OLD.organization_id),
      TG_TABLE_NAME,
      NEW.id,
      CASE 
        WHEN NEW.status IS DISTINCT FROM OLD.status THEN 'status_change'
        ELSE TG_OP
      END,
      key,
      (to_jsonb(OLD)) ->> key,
      (to_jsonb(NEW)) ->> key,
      COALESCE(NEW.updated_by, auth.uid()),
      CASE 
        WHEN NEW.status IS DISTINCT FROM OLD.status THEN 
          CONCAT('Status changed from ', OLD.status, ' to ', NEW.status)
        ELSE 'Field updated'
      END
    FROM jsonb_each_text(to_jsonb(NEW)) 
    WHERE (to_jsonb(NEW)) ->> key IS DISTINCT FROM (to_jsonb(OLD)) ->> key
      AND key NOT IN ('updated_at', 'created_at');
      
    RETURN NEW;
  END IF;
  
  -- Insert audit record for INSERT operations
  IF TG_OP = 'INSERT' THEN
    INSERT INTO public.audit_trail (
      organization_id, table_name, record_id, action, changed_by, change_reason
    ) VALUES (
      NEW.organization_id,
      TG_TABLE_NAME,
      NEW.id,
      TG_OP,
      COALESCE(NEW.created_by, auth.uid()),
      CONCAT(TG_TABLE_NAME, ' created')
    );
    RETURN NEW;
  END IF;
  
  RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_audit_trail()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
declare
  v_org_id uuid;
begin
  -- Safely read either organization_id OR org_id if present on NEW
  v_org_id :=
    coalesce(
      nullif(to_jsonb(NEW)->>'organization_id','')::uuid,
      nullif(to_jsonb(NEW)->>'org_id','')::uuid
    );

  insert into public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  )
  values (
    v_org_id,
    TG_TABLE_NAME,
    NEW.id,
    TG_OP,
    coalesce(auth.uid(), '00000000-0000-0000-0000-000000000001'::uuid),
    'system'
  );

  return NEW;
end
$function$
;

CREATE OR REPLACE FUNCTION public.log_milestone_status_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Only log if status actually changed
  IF OLD.status IS DISTINCT FROM NEW.status THEN
    INSERT INTO public.milestone_status_history (
      entity_type,
      entity_id,
      organization_id,
      old_status,
      new_status,
      change_reason,
      changed_by
    ) VALUES (
      CASE WHEN TG_TABLE_NAME = 'milestones' THEN 'milestone' ELSE 'task' END,
      NEW.id,
      NEW.organization_id,
      OLD.status,
      NEW.status,
      'Status updated via application',
      NEW.updated_by
    );
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_policy_change(title_param text, type_param text, domain_scope_param text, summary_param text, linked_document_id_param text DEFAULT NULL::text, tags_param text[] DEFAULT '{}'::text[], logged_by_param text DEFAULT 'System'::text, organization_id_param uuid DEFAULT NULL::uuid, metadata_param jsonb DEFAULT '{}'::jsonb)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  new_log_id UUID;
BEGIN
  INSERT INTO public.policy_change_log (
    title,
    type,
    domain_scope,
    linked_document_id,
    summary,
    tags,
    logged_by,
    organization_id,
    metadata
  ) VALUES (
    title_param,
    type_param,
    domain_scope_param,
    linked_document_id_param,
    summary_param,
    tags_param,
    logged_by_param,
    organization_id_param,
    metadata_param
  ) RETURNING id INTO new_log_id;
  
  RETURN new_log_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_security_event(event_type text, details jsonb DEFAULT '{}'::jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  INSERT INTO public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  ) VALUES (
    '00000000-0000-0000-0000-000000000000'::uuid,
    'security_events',
    auth.uid(),
    event_type,
    auth.uid(),
    details::text
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_security_event(event_type text, event_details jsonb DEFAULT '{}'::jsonb, severity_level text DEFAULT 'medium'::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  INSERT INTO public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason,
    field_name,
    new_value
  ) VALUES (
    '00000000-0000-0000-0000-000000000000'::uuid,
    'security_events',
    COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid),
    event_type,
    COALESCE(auth.uid(), '00000000-0000-0000-000000000000'::uuid),
    'Security event logged with severity: ' || severity_level,
    'event_details',
    event_details::text
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_security_event(event_type text, event_details text, severity_level text DEFAULT 'MEDIUM'::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  INSERT INTO public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason,
    field_name
  ) VALUES (
    '00000000-0000-0000-0000-000000000000'::uuid,
    'security_monitoring',
    auth.uid(),
    event_type,
    auth.uid(),
    event_details,
    severity_level
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_security_metric(metric_type_param text, metric_value_param numeric, metadata_param jsonb DEFAULT '{}'::jsonb, organization_id_param uuid DEFAULT NULL::uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  INSERT INTO public.security_monitoring (
    metric_type,
    metric_value,
    metadata,
    organization_id
  ) VALUES (
    metric_type_param,
    metric_value_param,
    metadata_param,
    organization_id_param
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_upload_context_validation(session_id_param text, organization_id_param uuid, user_id_param uuid, validation_result_param boolean, error_details_param text DEFAULT NULL::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  INSERT INTO audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason,
    field_name,
    new_value
  ) VALUES (
    organization_id_param,
    'upload_session_log',
    user_id_param,
    CASE WHEN validation_result_param THEN 'CONTEXT_VALIDATION_SUCCESS' ELSE 'CONTEXT_VALIDATION_FAILED' END,
    user_id_param,
    COALESCE(error_details_param, 'Organization context validation for upload session'),
    'session_id',
    session_id_param
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.match_ai_chunks(p_org_id uuid, p_query_embedding vector, p_match_count integer DEFAULT 8, p_min_score double precision DEFAULT 0.0)
 RETURNS TABLE(id uuid, document_id uuid, content text, chunk_index integer, document_title text, doc_type text, score double precision)
 LANGUAGE sql
 STABLE
AS $function$
  SELECT
    adc.id, adc.document_id, adc.content, adc.chunk_index,
    ad.title AS document_title, ad.document_type AS doc_type,
    1 - (adc.embedding <=> p_query_embedding) AS score
  FROM public.ai_document_chunks adc
  JOIN public.ai_documents ad ON ad.id = adc.document_id
  WHERE ad.organization_id = p_org_id
    AND adc.organization_id = p_org_id
    AND adc.embedding IS NOT NULL
    AND COALESCE(adc.is_clean, true) = true
    AND COALESCE(ad.processing_status,'completed') = 'completed'
  ORDER BY adc.embedding <=> p_query_embedding
  LIMIT p_match_count
$function$
;

CREATE OR REPLACE FUNCTION public.match_ai_chunks(query_embedding vector, match_count integer DEFAULT 5, match_threshold double precision DEFAULT 0.35)
 RETURNS TABLE(document_id uuid, content text, distance double precision)
 LANGUAGE sql
 STABLE
AS $function$
  select
    t.document_id,
    t.content,
    (t.embedding <=> query_embedding) as distance
  from public.chunks t
  where 1 - (t.embedding <=> query_embedding) >= match_threshold
  order by t.embedding <=> query_embedding
  limit match_count;
$function$
;

CREATE OR REPLACE FUNCTION public.org_domains_sync_org_id()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
  NEW.organization_id := NEW.org_id;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.prevent_self_approval()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  -- Prevent self-approval for admin-related requests
  IF NEW.approved_by = OLD.requested_by THEN
    RAISE EXCEPTION 'Users cannot approve their own requests. Violation logged.';
  END IF;
  
  -- Log the approval attempt in audit trail
  INSERT INTO public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    field_name,
    old_value,
    new_value,
    changed_by,
    change_reason
  ) VALUES (
    '00000000-0000-0000-0000-000000000000'::uuid,
    'admin_approval_requests',
    NEW.id,
    'APPROVAL_ATTEMPT',
    'status',
    OLD.status,
    NEW.status,
    NEW.approved_by,
    CASE 
      WHEN NEW.approved_by = OLD.requested_by THEN 'BLOCKED: Self-approval attempt'
      ELSE 'Valid approval by different admin'
    END
  );
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.regenerate_missing_embeddings()
 RETURNS TABLE(chunks_updated bigint)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  updated_count bigint;
BEGIN
  -- Count chunks that need embeddings
  SELECT COUNT(*) INTO updated_count
  FROM ai_document_chunks
  WHERE embedding IS NULL
    AND content IS NOT NULL
    AND length(trim(content)) > 0;
  
  -- Log the embedding regeneration need
  INSERT INTO audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  ) 
  SELECT DISTINCT
    ad.organization_id,
    'ai_document_chunks',
    ad.organization_id,
    'embedding_regeneration_needed',
    '00000000-0000-0000-0000-000000000001'::uuid,
    'Found ' || updated_count || ' chunks without embeddings that need regeneration'
  FROM ai_document_chunks adc
  JOIN ai_documents ad ON adc.document_id = ad.id
  WHERE adc.embedding IS NULL
    AND adc.content IS NOT NULL
    AND length(trim(adc.content)) > 0;
  
  RETURN QUERY SELECT updated_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.regenerate_missing_embeddings_for_org(org_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  missing_count integer;
  total_count integer;
  result jsonb;
BEGIN
  -- Count chunks without embeddings
  SELECT COUNT(*) INTO missing_count
  FROM ai_document_chunks 
  WHERE organization_id = org_id 
    AND embedding IS NULL
    AND content IS NOT NULL
    AND length(trim(content)) > 0;
    
  SELECT COUNT(*) INTO total_count
  FROM ai_document_chunks 
  WHERE organization_id = org_id;
  
  -- Log the need for regeneration
  INSERT INTO audit_trail (
    organization_id,
    table_name, 
    record_id,
    action,
    changed_by,
    change_reason
  ) VALUES (
    org_id,
    'ai_document_chunks',
    org_id,
    'EMBEDDING_REGENERATION_REQUESTED',
    '00000000-0000-0000-0000-000000000001'::uuid,
    format('Found %s chunks without embeddings out of %s total chunks', missing_count, total_count)
  );
  
  result := jsonb_build_object(
    'organization_id', org_id,
    'total_chunks', total_count,
    'missing_embeddings', missing_count,
    'embedding_percentage', round(100.0 * (total_count - missing_count) / NULLIF(total_count, 0), 2),
    'needs_regeneration', missing_count > 0
  );
  
  RETURN result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.request_admin_access(target_user_email text, justification text)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  requesting_user_id uuid;
  target_user_id uuid;
  existing_admin_count integer;
  request_id uuid;
BEGIN
  requesting_user_id := auth.uid();
  
  -- Validate input
  IF NOT public.validate_input_security(target_user_email || justification) THEN
    RETURN json_build_object('success', false, 'error', 'Security validation failed');
  END IF;
  
  -- Check if requester is already an admin (only existing admins can grant access)
  IF NOT public.is_user_admin(requesting_user_id) THEN
    -- For initial setup, allow if no admins exist
    SELECT COUNT(*) INTO existing_admin_count FROM public.admin_users;
    
    IF existing_admin_count > 0 THEN
      INSERT INTO public.audit_trail (
        organization_id, table_name, record_id, action, changed_by, change_reason
      ) VALUES (
        '00000000-0000-0000-0000-000000000000'::uuid,
        'admin_access_requests',
        requesting_user_id,
        'UNAUTHORIZED_ADMIN_REQUEST',
        requesting_user_id,
        'Non-admin attempted to request admin access for: ' || target_user_email
      );
      
      RETURN json_build_object('success', false, 'error', 'Only existing admins can grant admin access');
    END IF;
  END IF;
  
  -- Get target user ID
  SELECT id INTO target_user_id 
  FROM auth.users 
  WHERE email = target_user_email;
  
  IF target_user_id IS NULL THEN
    RETURN json_build_object('success', false, 'error', 'User not found');
  END IF;
  
  -- Check if user is already admin
  IF public.is_user_admin(target_user_id) THEN
    RETURN json_build_object('success', false, 'error', 'User is already an admin');
  END IF;
  
  -- Create admin approval request
  INSERT INTO public.admin_approval_requests (
    request_type,
    entity_type,
    entity_id,
    requested_by,
    requested_changes
  ) VALUES (
    'GRANT_ADMIN_ACCESS',
    'user',
    target_user_id,
    requesting_user_id,
    json_build_object(
      'target_email', target_user_email,
      'justification', justification
    )
  ) RETURNING id INTO request_id;
  
  -- If no existing admins, auto-approve (initial setup)
  IF existing_admin_count = 0 THEN
    UPDATE public.admin_approval_requests 
    SET status = 'approved', approved_by = requesting_user_id 
    WHERE id = request_id;
    
    -- Grant admin access
    INSERT INTO public.admin_users (user_id, email, granted_by)
    VALUES (target_user_id, target_user_email, requesting_user_id);
    
    RETURN json_build_object('success', true, 'message', 'Admin access granted (initial setup)');
  END IF;
  
  RETURN json_build_object('success', true, 'message', 'Admin access request created, awaiting approval');
END;
$function$
;

CREATE OR REPLACE FUNCTION public.requeue_failed_crawls(max_retries integer DEFAULT 3)
 RETURNS bigint
 LANGUAGE plpgsql
AS $function$
declare
  v_count bigint;
begin
  update public.org_crawl_queue
  set status       = 'queued',
      retry_count  = coalesce(retry_count,0) + 1,
      last_attempt_at = now(),
      updated_at   = now(),
      error_reason = null
  where status = 'failed'
    and coalesce(retry_count,0) < max_retries;

  get diagnostics v_count = row_count;
  return v_count;
end$function$
;

CREATE OR REPLACE FUNCTION public.reset_failed_document(doc_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Delete any existing chunks for this document
  DELETE FROM public.ai_document_chunks WHERE document_id = doc_id;
  
  -- Reset the document status to pending
  UPDATE public.ai_documents 
  SET processing_status = 'pending',
      processed_at = NULL,
      total_chunks = 0,
      updated_at = now()
  WHERE id = doc_id;
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.reset_mps_documents_for_reprocessing(target_organization_id uuid)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  doc_count INTEGER;
  criteria_count INTEGER;
  chunk_count INTEGER;
  result json;
  executing_user_id uuid;
BEGIN
  -- Get executing user or use a system placeholder
  executing_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  -- Count what we're about to reset
  SELECT COUNT(*) INTO doc_count
  FROM ai_documents 
  WHERE organization_id = target_organization_id 
    AND document_type = 'mps_document';
  
  SELECT COUNT(*) INTO criteria_count
  FROM criteria c
  JOIN maturity_practice_statements mps ON c.mps_id = mps.id
  WHERE mps.organization_id = target_organization_id;
  
  SELECT COUNT(*) INTO chunk_count
  FROM ai_document_chunks adc
  JOIN ai_documents ad ON adc.document_id = ad.id
  WHERE ad.organization_id = target_organization_id 
    AND ad.document_type = 'mps_document';
  
  -- Reset AI document chunks for MPS documents
  DELETE FROM ai_document_chunks 
  WHERE document_id IN (
    SELECT id FROM ai_documents 
    WHERE organization_id = target_organization_id 
      AND document_type = 'mps_document'
  );
  
  -- Clear old criteria tied to MPS documents
  DELETE FROM criteria 
  WHERE mps_id IN (
    SELECT id FROM maturity_practice_statements 
    WHERE organization_id = target_organization_id
  );
  
  -- Clear maturity levels associated with old criteria
  DELETE FROM maturity_levels 
  WHERE organization_id = target_organization_id;
  
  -- Clear assessment scores for old criteria
  DELETE FROM assessment_scores 
  WHERE organization_id = target_organization_id;
  
  -- Reset MPS documents to pending status
  UPDATE ai_documents 
  SET 
    processing_status = 'pending',
    processed_at = NULL,
    total_chunks = 0,
    updated_at = now()
  WHERE organization_id = target_organization_id 
    AND document_type = 'mps_document';
  
  -- Reset MPS status to not_started
  UPDATE maturity_practice_statements 
  SET 
    status = 'not_started',
    updated_at = now()
  WHERE organization_id = target_organization_id;
  
  -- Reset domain status to not_started
  UPDATE domains 
  SET 
    status = 'not_started',
    updated_at = now()
  WHERE organization_id = target_organization_id;
  
  -- Create audit log entry with fallback user
  INSERT INTO audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  ) VALUES (
    target_organization_id,
    'ai_documents',
    target_organization_id,
    'bulk_reset',
    executing_user_id,
    'MPS documents reset for reprocessing with new AI Interpretation Rule'
  );
  
  -- Return summary of what was reset
  result := json_build_object(
    'success', true,
    'documents_reset', doc_count,
    'criteria_cleared', criteria_count,
    'chunks_cleared', chunk_count,
    'message', 'MPS documents successfully reset for reprocessing'
  );
  
  RETURN result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.reset_my_mps_documents()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  user_org_id uuid;
  result json;
BEGIN
  -- Get the user's organization ID
  SELECT organization_id INTO user_org_id
  FROM organization_members 
  WHERE user_id = auth.uid() 
    AND role IN ('owner', 'admin')
  LIMIT 1;
  
  IF user_org_id IS NULL THEN
    RETURN json_build_object(
      'success', false,
      'error', 'No organization found or insufficient permissions'
    );
  END IF;
  
  -- Call the main reset function
  SELECT public.reset_mps_documents_for_reprocessing(user_org_id) INTO result;
  
  RETURN result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.run_system_report()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
declare
  v_docs_total bigint;
  v_chunks_total bigint;
  v_chunks_chars numeric;
  v_docs_without_chunks bigint;
  v_queue jsonb;
begin
  select count(*) into v_docs_total from public.ai_documents;
  select count(*), coalesce(sum(length(content))::numeric,0) into v_chunks_total, v_chunks_chars from public.ai_document_chunks;
  select count(*) into v_docs_without_chunks
  from public.ai_documents d
  left join public.ai_document_chunks c on c.document_id = d.id
  where c.id is null;

  select coalesce(jsonb_agg(jsonb_build_object('status', status, 'count', cnt)), '[]'::jsonb)
  into v_queue
  from (
    select status, count(*) as cnt
    from public.org_crawl_queue
    group by status
    order by status
  ) q;

  insert into public.system_reports(summary)
  values (jsonb_build_object(
    'ts', now(),
    'documents_total', v_docs_total,
    'chunks_total', v_chunks_total,
    'chunk_chars_total', v_chunks_chars,
    'docs_without_chunks', v_docs_without_chunks,
    'crawl_queue', v_queue,
    'notes', 'Daily Maturion health snapshot'
  ));
end
$function$
;

CREATE OR REPLACE FUNCTION public.set_organization_owner_before_insert()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  -- Always set owner_id to current authenticated user
  NEW.owner_id = auth.uid();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.set_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.updated_at = now();
  return new;
end$function$
;

CREATE OR REPLACE FUNCTION public.touch_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
begin
  new.updated_at = now();
  return new;
end$function$
;

CREATE OR REPLACE FUNCTION public.unstick_fetching_jobs(max_age interval DEFAULT '00:30:00'::interval)
 RETURNS bigint
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
declare v_count bigint;
begin
  update public.org_crawl_queue
  set status='queued', updated_at=now(), error_reason='fetching_timeout'
  where status='fetching' and updated_at < now() - max_age;
  get diagnostics v_count = row_count;
  return v_count;
end$function$
;

CREATE OR REPLACE FUNCTION public.update_ai_ingested_status()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Auto-mark as AI ingested when processing completes with chunks
  IF NEW.processing_status = 'completed' AND NEW.total_chunks > 0 THEN
    NEW.is_ai_ingested = true;
  ELSIF NEW.processing_status IN ('pending', 'processing', 'failed') THEN
    NEW.is_ai_ingested = false;
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_milestone_status_on_task_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO ''
AS $function$
DECLARE
  total_tasks INTEGER;
  signed_off_tasks INTEGER;
  new_status public.milestone_status;
BEGIN
  -- Count total tasks for this milestone
  SELECT COUNT(*) INTO total_tasks
  FROM public.milestone_tasks 
  WHERE milestone_id = NEW.milestone_id;
  
  -- Count signed off tasks for this milestone
  SELECT COUNT(*) INTO signed_off_tasks
  FROM public.milestone_tasks 
  WHERE milestone_id = NEW.milestone_id 
    AND status = 'signed_off';
  
  -- Determine new milestone status
  IF total_tasks = 0 THEN
    new_status := 'not_started';
  ELSIF signed_off_tasks = total_tasks THEN
    new_status := 'signed_off';
  ELSIF signed_off_tasks > 0 THEN
    new_status := 'in_progress';
  ELSE
    new_status := 'not_started';
  END IF;
  
  -- Update milestone status
  UPDATE public.milestones 
  SET status = new_status,
      updated_at = now(),
      updated_by = NEW.updated_by
  WHERE id = NEW.milestone_id;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_milestone_status_on_task_delete()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  total_tasks INTEGER;
  signed_off_tasks INTEGER;
  new_status public.milestone_status;
BEGIN
  -- Count total tasks for this milestone
  SELECT COUNT(*) INTO total_tasks
  FROM public.milestone_tasks 
  WHERE milestone_id = OLD.milestone_id;
  
  -- Count signed off tasks for this milestone
  SELECT COUNT(*) INTO signed_off_tasks
  FROM public.milestone_tasks 
  WHERE milestone_id = OLD.milestone_id 
    AND status = 'signed_off';
  
  -- Determine new milestone status
  IF total_tasks = 0 THEN
    new_status := 'not_started';
  ELSIF signed_off_tasks = total_tasks THEN
    new_status := 'signed_off';
  ELSIF signed_off_tasks > 0 THEN
    new_status := 'in_progress';
  ELSE
    new_status := 'not_started';
  END IF;
  
  -- Update milestone status
  UPDATE public.milestones 
  SET status = new_status,
      updated_at = now(),
      updated_by = OLD.updated_by
  WHERE id = OLD.milestone_id;
  
  RETURN OLD;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO ''
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.user_can_access_organization_context(org_id uuid, user_id uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
    SELECT EXISTS (
        -- Direct membership
        SELECT 1 FROM organization_members om
        WHERE om.organization_id = org_id AND om.user_id = user_id
    ) OR EXISTS (
        -- Parent organization access (can access subsidiaries)
        SELECT 1 FROM organization_members om
        JOIN organizations child ON child.parent_organization_id = om.organization_id
        WHERE child.id = org_id AND om.user_id = user_id AND om.role IN ('owner', 'admin')
    ) OR (
        -- Superuser access
        is_superuser(user_id)
    );
$function$
;

CREATE OR REPLACE FUNCTION public.user_can_manage_org_invitations(org_id uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
  SELECT EXISTS (
    -- User is organization owner
    SELECT 1 FROM public.organizations 
    WHERE id = org_id AND owner_id = auth.uid()
  ) OR EXISTS (
    -- User is organization admin/owner member
    SELECT 1 FROM public.organization_members 
    WHERE organization_id = org_id 
      AND user_id = auth.uid() 
      AND role IN ('admin', 'owner')
  );
$function$
;

CREATE OR REPLACE FUNCTION public.user_can_upload_to_organization(org_id uuid, user_id uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Check if user is a backoffice admin (bypass for internal uploads)
  IF EXISTS (
    SELECT 1 FROM public.backoffice_admins 
    WHERE backoffice_admins.user_id = user_can_upload_to_organization.user_id
  ) THEN
    -- Log backoffice access for audit (function is now VOLATILE so this works)
    INSERT INTO public.audit_trail (
      organization_id,
      table_name,
      record_id,
      action,
      changed_by,
      change_reason
    ) VALUES (
      org_id,
      'backoffice_upload_access',
      user_can_upload_to_organization.user_id,
      'BACKOFFICE_UPLOAD_ACCESS_GRANTED',
      user_can_upload_to_organization.user_id,
      'Backoffice admin bypass for upload permission'
    );
    
    RETURN TRUE;
  END IF;
  
  -- Standard organization member check
  RETURN EXISTS (
    SELECT 1 
    FROM public.organization_members om
    WHERE om.organization_id = org_id 
      AND om.user_id = user_can_upload_to_organization.user_id
      AND om.role IN ('admin', 'owner')
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.user_can_view_organization(org_id uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
  SELECT EXISTS (
    -- User is owner
    SELECT 1 FROM public.organizations 
    WHERE id = org_id AND owner_id = auth.uid()
  ) OR EXISTS (
    -- User is member
    SELECT 1 FROM public.organization_members 
    WHERE organization_id = org_id AND user_id = auth.uid()
  ) OR EXISTS (
    -- User has pending invitation
    SELECT 1 FROM public.organization_invitations 
    WHERE organization_id = org_id 
      AND email = (auth.jwt() ->> 'email'::text)
      AND status = 'pending'
      AND expires_at > now()
  );
$function$
;

CREATE OR REPLACE FUNCTION public.user_has_role(user_uuid uuid, required_role text DEFAULT 'admin'::text)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
  SELECT EXISTS (
    SELECT 1 FROM public.admin_users 
    WHERE user_id = user_uuid 
      AND role = required_role
  );
$function$
;

CREATE OR REPLACE FUNCTION public.validate_admin_operation(operation_type text)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  current_user_id uuid;
  is_valid_admin boolean;
BEGIN
  -- Get current user
  current_user_id := auth.uid();
  
  -- Check if user is authenticated
  IF current_user_id IS NULL THEN
    RETURN false;
  END IF;
  
  -- Check if user is admin using the secure function
  SELECT public.user_has_role(current_user_id, 'admin') INTO is_valid_admin;
  
  -- Log the operation attempt
  INSERT INTO public.audit_trail (
    organization_id,
    table_name,
    record_id,
    action,
    changed_by,
    change_reason
  ) VALUES (
    '00000000-0000-0000-0000-000000000000'::uuid,
    'admin_operations',
    current_user_id,
    operation_type,
    current_user_id,
    CASE 
      WHEN is_valid_admin THEN 'Valid admin operation'
      ELSE 'BLOCKED: Unauthorized admin operation attempt'
    END
  );
  
  RETURN is_valid_admin;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_file_upload(file_name text, file_size bigint, mime_type text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  sanitized_name text;
  max_size_mb integer := 100; -- 100MB limit
  allowed_types text[] := ARRAY[
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/msword',
    'text/plain',
    'text/csv',
    'text/markdown',
    'application/vnd.ms-excel',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    -- Add PowerPoint support for Layer-3 extraction (training slides)
    'application/vnd.ms-powerpoint.presentation.macroEnabled.12',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation',
    'application/vnd.ms-powerpoint'
  ];
BEGIN
  -- Check file size (convert to MB)
  IF file_size > (max_size_mb * 1024 * 1024) THEN
    RETURN jsonb_build_object(
      'valid', false,
      'error', 'File size exceeds ' || max_size_mb || 'MB limit'
    );
  END IF;
  
  -- Check MIME type or file extension for better PowerPoint detection
  IF NOT (mime_type = ANY(allowed_types)) AND 
     NOT (file_name ~* '\.(pptm|pptx|ppt)$') THEN
    RETURN jsonb_build_object(
      'valid', false,
      'error', 'File type not allowed. Supported: PDF, Word, Excel, PowerPoint (.pptm/.pptx), Text, CSV, Markdown'
    );
  END IF;
  
  -- Sanitize filename: remove special characters, normalize spaces and dashes
  sanitized_name := file_name;
  
  -- Replace special characters with safe alternatives
  sanitized_name := regexp_replace(sanitized_name, '[^\w\s\.-]', '', 'g');
  -- Replace multiple spaces/underscores with single dash
  sanitized_name := regexp_replace(sanitized_name, '[\s_]+', '-', 'g');
  -- Replace multiple dashes with single dash
  sanitized_name := regexp_replace(sanitized_name, '-+', '-', 'g');
  -- Remove leading/trailing dashes
  sanitized_name := trim(sanitized_name, '-');
  
  -- Ensure filename isn't empty after sanitization
  IF LENGTH(sanitized_name) = 0 THEN
    sanitized_name := 'document-' || extract(epoch from now())::bigint;
  END IF;
  
  -- Return success with sanitized name
  RETURN jsonb_build_object(
    'valid', true,
    'sanitized_name', sanitized_name
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_input_security(input_text text)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  security_patterns text[] := ARRAY[
    'DROP\s+TABLE',
    'DELETE\s+FROM',
    'TRUNCATE\s+TABLE',
    'ALTER\s+TABLE',
    'CREATE\s+TABLE',
    'INSERT\s+INTO.*admin_users',
    'UPDATE.*admin_users',
    'GRANT\s+',
    'REVOKE\s+',
    '<script[^>]*>',
    'javascript:',
    'on\w+\s*=',
    'eval\s*\(',
    'expression\s*\('
  ];
  pattern text;
BEGIN
  -- Check for malicious patterns
  FOREACH pattern IN ARRAY security_patterns
  LOOP
    IF input_text ~* pattern THEN
      -- Log security violation
      INSERT INTO public.audit_trail (
        organization_id,
        table_name,
        record_id,
        action,
        changed_by,
        change_reason
      ) VALUES (
        '00000000-0000-0000-0000-000000000000'::uuid,
        'security_validation',
        auth.uid(),
        'SECURITY_VIOLATION_DETECTED',
        auth.uid(),
        'Malicious pattern detected: ' || pattern
      );
      
      RETURN false;
    END IF;
  END LOOP;
  
  RETURN true;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_organization_access(target_org_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  user_has_access boolean := false;
  user_is_backoffice boolean := false;
BEGIN
  -- Check if user is a backoffice admin (bypass for internal uploads)
  SELECT EXISTS (
    SELECT 1 FROM public.backoffice_admins 
    WHERE user_id = auth.uid()
  ) INTO user_is_backoffice;
  
  IF user_is_backoffice THEN
    user_has_access := true;
    
    -- Log backoffice access
    INSERT INTO public.audit_trail (
      organization_id,
      table_name,
      record_id,
      action,
      changed_by,
      change_reason
    ) VALUES (
      target_org_id,
      'backoffice_access_validation',
      auth.uid(),
      'BACKOFFICE_ACCESS_GRANTED',
      auth.uid(),
      'Backoffice admin bypass for organization access validation'
    );
  ELSE
    -- Standard organization member check
    SELECT EXISTS (
      SELECT 1 FROM public.organization_members
      WHERE organization_id = target_org_id
        AND user_id = auth.uid()
        AND role IN ('owner', 'admin', 'assessor')
    ) INTO user_has_access;
    
    -- Log standard access attempt
    INSERT INTO public.audit_trail (
      organization_id,
      table_name,
      record_id,
      action,
      changed_by,
      change_reason
    ) VALUES (
      target_org_id,
      'organization_access_validation',
      auth.uid(),
      CASE WHEN user_has_access THEN 'ACCESS_GRANTED' ELSE 'ACCESS_DENIED' END,
      auth.uid(),
      'Standard organization access validation for: ' || target_org_id::text
    );
  END IF;
  
  RETURN user_has_access;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_password_strength(password_text text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  issues text[] := '{}';
  strength_score integer := 0;
BEGIN
  -- Check minimum length
  IF length(password_text) < 12 THEN
    issues := array_append(issues, 'Password must be at least 12 characters long');
  ELSE
    strength_score := strength_score + 1;
  END IF;
  
  -- Check for uppercase letters
  IF password_text !~ '[A-Z]' THEN
    issues := array_append(issues, 'Password must contain at least one uppercase letter');
  ELSE
    strength_score := strength_score + 1;
  END IF;
  
  -- Check for lowercase letters
  IF password_text !~ '[a-z]' THEN
    issues := array_append(issues, 'Password must contain at least one lowercase letter');
  ELSE
    strength_score := strength_score + 1;
  END IF;
  
  -- Check for numbers
  IF password_text !~ '[0-9]' THEN
    issues := array_append(issues, 'Password must contain at least one number');
  ELSE
    strength_score := strength_score + 1;
  END IF;
  
  -- Check for special characters
  IF password_text !~ '[!@#$%^&*()_+\-=\[\]{};:"\\|,.<>/?]' THEN
    issues := array_append(issues, 'Password must contain at least one special character');
  ELSE
    strength_score := strength_score + 1;
  END IF;
  
  -- Check for common patterns
  IF password_text ~* '(password|123456|qwerty|admin|test|user)' THEN
    issues := array_append(issues, 'Password contains common words that should be avoided');
    strength_score := strength_score - 1;
  END IF;
  
  -- Return validation result
  RETURN jsonb_build_object(
    'valid', array_length(issues, 1) = 0,
    'issues', issues,
    'strength_score', GREATEST(0, strength_score),
    'strength_level', 
      CASE 
        WHEN strength_score >= 5 THEN 'strong'
        WHEN strength_score >= 3 THEN 'medium'
        ELSE 'weak'
      END
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_secure_input(input_text text)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO ''
AS $function$
DECLARE
  suspicious_patterns text[] := ARRAY[
    '<script',
    'javascript:',
    'on\w+\s*=',
    'eval\s*\(',
    'document\.',
    'window\.',
    'alert\(',
    'confirm\(',
    'prompt\('
  ];
  pattern text;
BEGIN
  IF input_text IS NULL THEN
    RETURN true;
  END IF;
  
  -- Check for suspicious patterns
  FOREACH pattern IN ARRAY suspicious_patterns
  LOOP
    IF input_text ~* pattern THEN
      -- Log security violation
      INSERT INTO public.audit_trail (
        organization_id,
        table_name,
        record_id,
        action,
        changed_by,
        change_reason
      ) VALUES (
        '00000000-0000-0000-0000-000000000000'::uuid,
        'security_validation',
        auth.uid(),
        'MALICIOUS_INPUT_BLOCKED',
        auth.uid(),
        'Blocked potentially malicious input, pattern: ' || pattern
      );
      
      RETURN false;
    END IF;
  END LOOP;
  
  RETURN true;
END;
$function$
;



